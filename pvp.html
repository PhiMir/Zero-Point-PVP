<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Zero Point: PVP</title>
  
  <!-- React / Babel / Tailwind -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background-color: #0f172a;
      color: white;
      -webkit-tap-highlight-color: transparent;
    }
    .animate-fade-in { animation: fadeIn 0.35s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .glass {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAy9neN8_-8HWZNcQluP6jGbzNQMICWc6s",
      authDomain: "zero-pvp.firebaseapp.com",
      projectId: "zero-pvp",
      storageBucket: "zero-pvp.firebasestorage.app",
      messagingSenderId: "634718710928",
      appId: "1:634718710928:web:b5339abd5d443c1ca83c15",
      databaseURL: "https://zero-pvp-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ìŠ¹ë¶€ íŒë‹¨ (0~10, 10 > 0)
    const getWinnerUid = (uidA, cardA, uidB, cardB) => {
      if (cardA === cardB) return null; // ë¬´ìŠ¹ë¶€
      if (cardA === 10 && cardB === 0) return uidA;
      if (cardB === 10 && cardA === 0) return uidB;
      return cardA < cardB ? uidA : uidB;
    };

    // ìŠ¤í‚¬ ì •ì˜ (ì„¤ëª…ì€ ê¸°ì¡´ ì‹±ê¸€ í”Œë ˆì´ ì½”ë“œ ê¸°ë°˜)
    const SKILL_DEFS = {
      'self-plus':  { id: 'self-plus',  name: 'ë³¸ì¸+1',  color: 'bg-green-600' },
      'self-minus': { id: 'self-minus', name: 'ë³¸ì¸-1',  color: 'bg-green-500' },
      'opp-plus':   { id: 'opp-plus',   name: 'ìƒëŒ€+1',  color: 'bg-red-600'   },
      'opp-minus':  { id: 'opp-minus',  name: 'ìƒëŒ€-1',  color: 'bg-red-500'   },
      'double':     { id: 'double',     name: '2ë°°',     color: 'bg-yellow-600'},
      'random':     { id: 'random',     name: 'ëœë¤',    color: 'bg-purple-600'}
      // 'retrieve', 'nullify' ëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì¶”ê°€ ì˜ˆì •
    };
    const SKILL_IDS = Object.keys(SKILL_DEFS);
    const randomSkillId = () => SKILL_IDS[Math.floor(Math.random() * SKILL_IDS.length)];

    // ê³µí†µ: ìŠ¤í‚¬ íš¨ê³¼ ê³„ì‚° (ìˆ«ìë§Œ)
    const applySkillValue = (val, skillId, storedRandom) => {
      if (val === null || val === undefined) return val;
      let v = Number(val);
      if (isNaN(v)) return val;

      switch (skillId) {
        case 'self-plus':
        case 'opp-plus':
          return v + 1 > 10 ? 0 : v + 1;
        case 'self-minus':
        case 'opp-minus':
          return v - 1 < 0 ? 10 : v - 1;
        case 'double': {
          let doubled = Math.floor(v) * 2;
          return doubled > 10 ? doubled % 10 : doubled;
        }
        case 'random':
          return storedRandom;
        default:
          return v;
      }
    };

    // ==================== App ====================
    const App = () => {
      const [user, setUser] = useState(null);
      const [screen, setScreen] = useState('menu'); // menu, lobby, room, game
      const [playerName, setPlayerName] = useState('');
      const [currentRoomId, setCurrentRoomId] = useState(null);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          if (u) setUser(u);
          else auth.signInAnonymously();
        });
        return () => unsub();
      }, []);

      if (!user) {
        return (
          <div className="min-h-screen flex items-center justify-center text-slate-400">
            ì„œë²„ ì—°ê²° ì¤‘...
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-900 text-white overflow-hidden relative">
          {screen === 'menu' && (
            <MenuScreen
              onStart={(name) => {
                setPlayerName(name);
                setScreen('lobby');
              }}
            />
          )}

          {screen === 'lobby' && (
            <LobbyScreen
              user={user}
              playerName={playerName}
              onBack={() => setScreen('menu')}
              onJoinRoom={(roomId) => {
                setCurrentRoomId(roomId);
                setScreen('room');
              }}
            />
          )}

          {screen === 'room' && (
            <WaitingRoom
              user={user}
              playerName={playerName}
              roomId={currentRoomId}
              onGameStart={() => setScreen('game')}
              onLeave={() => {
                setScreen('lobby');
                setCurrentRoomId(null);
              }}
            />
          )}

          {screen === 'game' && (
            <GameScreen
              user={user}
              roomId={currentRoomId}
              onExit={() => {
                setScreen('lobby');
                setCurrentRoomId(null);
              }}
            />
          )}
        </div>
      );
    };

    // ==================== Menu ====================
    const MenuScreen = ({ onStart }) => {
      const [name, setName] = useState('');
      const handleSubmit = (e) => {
        e.preventDefault();
        const trimmed = name.trim();
        if (trimmed.length >= 2) onStart(trimmed);
      };

      return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
          <h1 className="text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 mb-3 tracking-tight">
            ZERO
          </h1>
          <p className="text-slate-400 mb-10 text-xs tracking-[0.35em] uppercase">
            Point PvP
          </p>

          <form onSubmit={handleSubmit} className="w-full max-w-xs glass p-6 rounded-2xl flex flex-col gap-4">
            <input
              type="text"
              value={name}
              onChange={e => setName(e.target.value)}
              placeholder="ë‹‰ë„¤ì„ (2~8ì)"
              maxLength={8}
              className="w-full px-4 py-3 bg-slate-800 rounded-xl text-center text-white outline-none border border-slate-700 focus:border-blue-500"
            />
            <button
              type="submit"
              disabled={name.trim().length < 2}
              className="w-full py-3 bg-blue-600 rounded-xl font-bold disabled:opacity-50"
            >
              ENTER LOBBY
            </button>
          </form>
        </div>
      );
    };

    // ==================== Lobby ====================
    const LobbyScreen = ({ user, playerName, onBack, onJoinRoom }) => {
      const [rooms, setRooms] = useState([]);

      useEffect(() => {
        const roomsRef = db.ref('rooms');
        const listener = roomsRef.on('value', (snapshot) => {
          const data = snapshot.val();
          const list = [];
          const now = Date.now();
          const EXPIRE_MS = 5 * 60 * 1000; // 5ë¶„

          if (data) {
            Object.entries(data).forEach(([roomId, room]) => {
              // 5ë¶„ ì´ìƒ ëŒ€ê¸° ìƒíƒœë©´ ë°© í­íŒŒ
              if (room.status === 'waiting' && room.createdAt && (now - room.createdAt) > EXPIRE_MS) {
                db.ref(`rooms/${roomId}`).remove();
                return;
              }

              // ìœ íš¨ì„± ì²´í¬
              if (!room.players || Object.keys(room.players).length === 0) return;
              if (!room.host || !room.host.uid) return;
              if (room.status !== 'waiting') return;

              list.push({ id: roomId, ...room });
            });
          }
          list.sort((a, b) => b.createdAt - a.createdAt);
          setRooms(list);
        });

        return () => roomsRef.off('value', listener);
      }, []);

      const createRoom = async () => {
        const roomRef = db.ref('rooms').push();
        const roomId = roomRef.key;

        await roomRef.set({
          status: 'waiting',
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          host: { uid: user.uid, name: playerName }
        });

        const playerRef = roomRef.child(`players/${user.uid}`);
        await playerRef.set({ name: playerName, ready: false });
        playerRef.onDisconnect().remove();

        onJoinRoom(roomId);
      };

      const joinRoom = async (roomId) => {
        const roomRef = db.ref(`rooms/${roomId}`);
        const snap = await roomRef.get();

        if (!snap.exists()) {
          alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
          return;
        }

        const room = snap.val();
        if (!room.players) {
          alert("í”Œë ˆì´ì–´ ì •ë³´ê°€ ì—†ëŠ” ë°©ì…ë‹ˆë‹¤.");
          return;
        }
        if (Object.keys(room.players).length >= 2) {
          alert("ì´ë¯¸ 2ëª…ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
          return;
        }

        const playerRef = roomRef.child(`players/${user.uid}`);
        await playerRef.set({ name: playerName, ready: false });
        playerRef.onDisconnect().remove();

        onJoinRoom(roomId);
      };

      return (
        <div className="min-h-screen p-4 max-w-2xl mx-auto animate-fade-in">
          <header className="flex justify-between items-center py-6">
            <button onClick={onBack} className="text-slate-400 hover:text-white">â† EXIT</button>
            <h2 className="font-bold text-xl tracking-[0.3em] uppercase text-slate-100">Lobby</h2>
            <div className="w-10"></div>
          </header>

          <div className="glass p-6 rounded-2xl mb-6 flex justify-between items-center">
            <div>
              <p className="text-xs text-slate-400">PLAYER</p>
              <p className="font-bold text-blue-400 text-lg">{playerName}</p>
            </div>
            <button
              onClick={createRoom}
              className="bg-blue-600 px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform"
            >
              + CREATE ROOM
            </button>
          </div>

          <div className="space-y-3">
            {rooms.length === 0 ? (
              <div className="text-center py-10 text-slate-500">
                ëŒ€ê¸° ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.
              </div>
            ) : (
              rooms.map(room => (
                <div
                  key={room.id}
                  className="bg-slate-800/90 p-5 rounded-xl flex justify-between items-center border border-slate-700"
                >
                  <div>
                    <div className="font-bold text-lg text-white">
                      {room.host.name}
                    </div>
                    <div className="text-xs text-slate-500">
                      #{room.id.slice(-4)} Â· {Object.keys(room.players || {}).length}/2
                    </div>
                  </div>
                  <button
                    onClick={() => joinRoom(room.id)}
                    className="bg-slate-700 hover:bg-green-600 px-6 py-2 rounded-lg font-bold text-white transition-colors"
                  >
                    JOIN
                  </button>
                </div>
              ))
            )}
          </div>
        </div>
      );
    };

    // ==================== Waiting Room ====================
    const WaitingRoom = ({ user, playerName, roomId, onLeave, onGameStart }) => {
      const [roomData, setRoomData] = useState(null);

      useEffect(() => {
        const roomRef = db.ref(`rooms/${roomId}`);

        const listener = roomRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (!data) {
            alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            onLeave();
            return;
          }
          setRoomData(data);

          if (data.status === 'playing') {
            onGameStart();
          }
        });

        return () => {
          roomRef.off('value', listener);
        };
      }, [roomId]);

      const handleLeave = async () => {
        if (!roomData) {
          onLeave();
          return;
        }
        const roomRef = db.ref(`rooms/${roomId}`);
        const isHost = roomData.host && roomData.host.uid === user.uid;

        if (isHost) {
          await roomRef.remove();
        } else {
          await roomRef.child(`players/${user.uid}`).remove();
        }
        onLeave();
      };

      const toggleReady = async () => {
        if (!roomData || !roomData.players || !roomData.players[user.uid]) return;
        const myReady = !!roomData.players[user.uid].ready;
        await db.ref(`rooms/${roomId}/players/${user.uid}/ready`).set(!myReady);
      };

      const startGame = async () => {
        if (!roomData) return;
        const roomRef = db.ref(`rooms/${roomId}`);
        await roomRef.update({
          status: 'playing',
          startedAt: firebase.database.ServerValue.TIMESTAMP
        });
      };

      if (!roomData || !roomData.players || !roomData.players[user.uid]) {
        return (
          <div className="min-h-screen flex items-center justify-center text-slate-400">
            ë°© ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        );
      }

      const me = roomData.players[user.uid];
      const isHost = roomData.host && roomData.host.uid === user.uid;
      const players = Object.entries(roomData.players);
      const opponentEntry = players.find(([uid]) => uid !== user.uid);
      const opponent = opponentEntry ? opponentEntry[1] : null;

      const amIReady = !!me.ready;
      const oppReady = opponent ? !!opponent.ready : false;
      const canStart = opponent && amIReady && oppReady;

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-900 animate-fade-in">
          <div className="w-full max-w-lg glass rounded-3xl p-8 shadow-2xl">
            <div className="text-center mb-8">
              <h2 className="text-2xl font-bold text-white">WAITING ROOM</h2>
              <div className="flex justify-center gap-2 mt-2">
                <span className="text-xs px-2 py-1 bg-slate-800 rounded text-slate-400">
                  Room ID: {roomId.slice(-4)}
                </span>
                {isHost && (
                  <span className="text-xs px-2 py-1 bg-yellow-900 text-yellow-200 rounded font-bold">
                    HOST
                  </span>
                )}
              </div>
            </div>

            <div className="flex justify-between items-center mb-12">
              {/* Me */}
              <div className="flex-1 flex flex-col items-center">
                <div
                  className={`w-20 h-20 rounded-full mb-3 flex items-center justify-center text-2xl font-black border-4 ${
                    amIReady ? 'border-green-500 bg-green-900/30 text-green-400' : 'border-blue-500 bg-slate-800'
                  }`}
                >
                  {me.name[0]}
                </div>
                <span className="font-bold text-white mb-1">{me.name}</span>
                <span
                  className={`text-xs px-2 py-1 rounded font-bold ${
                    amIReady ? 'bg-green-600' : 'bg-slate-700 text-slate-400'
                  }`}
                >
                  {amIReady ? 'READY' : 'WAITING'}
                </span>
              </div>

              <div className="text-2xl font-black text-slate-700 italic">VS</div>

              {/* Opponent */}
              <div className="flex-1 flex flex-col items-center">
                {opponent ? (
                  <>
                    <div
                      className={`w-20 h-20 rounded-full mb-3 flex items-center justify-center text-2xl font-black border-4 ${
                        oppReady ? 'border-green-500 bg-green-900/30 text-green-400' : 'border-red-500 bg-slate-800'
                      }`}
                    >
                      {opponent.name[0]}
                    </div>
                    <span className="font-bold text-white mb-1">{opponent.name}</span>
                    <span
                      className={`text-xs px-2 py-1 rounded font-bold ${
                        oppReady ? 'bg-green-600' : 'bg-slate-700 text-slate-400'
                      }`}
                    >
                      {oppReady ? 'READY' : 'WAITING'}
                    </span>
                  </>
                ) : (
                  <>
                    <div className="w-20 h-20 rounded-full mb-3 flex items-center justify-center bg-slate-800 border-4 border-dashed border-slate-700 animate-pulse">
                      ?
                    </div>
                    <span className="text-slate-500 text-sm">ìƒëŒ€ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</span>
                  </>
                )}
              </div>
            </div>

            <div className="space-y-3">
              {isHost ? (
                <>
                  <button
                    onClick={startGame}
                    disabled={!canStart}
                    className={`w-full py-4 rounded-xl font-black text-lg transition-all shadow-lg ${
                      canStart
                        ? 'bg-green-600 hover:bg-green-500 text-white animate-pulse'
                        : 'bg-slate-700 text-slate-500 cursor-not-allowed'
                    }`}
                  >
                    {opponent ? (canStart ? 'START GAME ğŸš€' : 'ë‘˜ ë‹¤ READY í•„ìš”') : 'ìƒëŒ€ ëŒ€ê¸° ì¤‘'}
                  </button>
                  <button
                    onClick={toggleReady}
                    className={`w-full py-3 rounded-xl font-bold text-sm transition-colors ${
                      amIReady ? 'bg-slate-700 text-slate-400' : 'bg-blue-600 text-white'
                    }`}
                  >
                    {amIReady ? 'ì¤€ë¹„ ì·¨ì†Œ' : 'ë°©ì¥ READY'}
                  </button>
                </>
              ) : (
                <button
                  onClick={toggleReady}
                  className={`w-full py-4 rounded-xl font-black text-lg transition-all shadow-lg active:scale-95 ${
                    amIReady ? 'bg-slate-700 text-slate-400' : 'bg-blue-600 text-white hover:bg-blue-500'
                  }`}
                >
                  {amIReady ? 'ì¤€ë¹„ ì·¨ì†Œ' : 'READY!'}
                </button>
              )}

              <button
                onClick={handleLeave}
                className="w-full py-3 text-slate-500 hover:text-white text-sm"
              >
                ë°© ë‚˜ê°€ê¸°
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ==================== Game Screen (PVP + ìŠ¤í‚¬) ====================
    const GameScreen = ({ user, roomId, onExit }) => {
      const [roomData, setRoomData] = useState(null);

      // ì‹¤ì‹œê°„ êµ¬ë… + í˜¸ìŠ¤íŠ¸ ì´ˆê¸°í™”(ê²Œì„/ìŠ¤í‚¬)
      useEffect(() => {
        const roomRef = db.ref(`rooms/${roomId}`);

        const listener = roomRef.on('value', async (snapshot) => {
          const data = snapshot.val();
          if (!data) {
            alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            onExit();
            return;
          }

          // í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì´ ì•„ì§ ì—†ìœ¼ë©´ ì´ˆê¸°í™” (ì†íŒ¨/ìŠ¤ì½”ì–´/ìŠ¤í‚¬)
          const isHost = data.host && data.host.uid === user.uid;
          if (isHost && !data.game && data.players) {
            const gamePlayers = {};
            Object.entries(data.players).forEach(([uid, p]) => {
              gamePlayers[uid] = {
                score: 0,
                hand: [0,1,2,3,4,5,6,7,8,9,10],
                selectedCard: null,
                effectiveCard: null,
                skills: [randomSkillId(), randomSkillId()] // ì‹œì‘ ìŠ¤í‚¬ 2ê°œ
              };
            });
            await roomRef.child('game').set({
              maxRounds: 5,
              currentRound: 1,
              phase: 'select', // select, skill, result, finished
              lastResult: null,
              skillLog: null,
              skillRequests: null,
              players: gamePlayers
            });
            return;
          }

          setRoomData(data);
        });

        return () => roomRef.off('value', listener);
      }, [roomId, user.uid, onExit]);

      if (!roomData || !roomData.game) {
        return (
          <div className="min-h-screen flex items-center justify-center text-slate-400">
            ê²Œì„ ì¤€ë¹„ ì¤‘...
          </div>
        );
      }

      const game = roomData.game;
      const isHost = roomData.host && roomData.host.uid === user.uid;
      const gamePlayers = game.players || {};
      const myGame = gamePlayers[user.uid];
      const oppUid = Object.keys(gamePlayers).find(uid => uid !== user.uid);
      const oppGame = oppUid ? gamePlayers[oppUid] : null;

      const myInfo = roomData.players[user.uid];
      const oppInfo = oppUid ? roomData.players[oppUid] : null;

      // ===== í˜¸ìŠ¤íŠ¸ ë¡œì§ 1: ë‘˜ ë‹¤ ì¹´ë“œ ì„ íƒë˜ë©´ skill í˜ì´ì¦ˆë¡œ ì „í™˜ & effectiveCard ì´ˆê¸°í™” =====
      useEffect(() => {
        if (!roomData || !roomData.game || !roomData.host) return;
        const g = roomData.game;
        const hostUid = roomData.host.uid;
        if (hostUid !== user.uid) return;  // í˜¸ìŠ¤íŠ¸ë§Œ

        if (g.phase !== 'select') return;
        const entries = Object.entries(g.players || {});
        if (entries.length < 2) return;
        const allSelected = entries.every(([uid, p]) =>
          p.selectedCard !== null && p.selectedCard !== undefined
        );
        if (!allSelected) return;

        const basePath = `rooms/${roomId}/game`;
        const updates = {};
        entries.forEach(([uid, p]) => {
          updates[`${basePath}/players/${uid}/effectiveCard`] = p.selectedCard;
        });
        updates[`${basePath}/phase`] = 'skill';
        updates[`${basePath}/lastResult`] = null;
        updates[`${basePath}/skillRequests`] = null;

        db.ref().update(updates);
      }, [roomData, roomId, user.uid]);

      // ===== í˜¸ìŠ¤íŠ¸ ë¡œì§ 2: skillRequests ì²˜ë¦¬ (ëª¨ë“  ìŠ¤í‚¬ íš¨ê³¼ ì„œë²„(í˜¸ìŠ¤íŠ¸)ì—ì„œë§Œ ì ìš©) =====
      useEffect(() => {
        if (!roomData || !roomData.game || !roomData.host) return;
        const g = roomData.game;
        const hostUid = roomData.host.uid;
        if (hostUid !== user.uid) return;  // í˜¸ìŠ¤íŠ¸ë§Œ
        if (g.phase !== 'skill') return;
        if (!g.skillRequests) return;

        const entriesReq = Object.entries(g.skillRequests);
        if (entriesReq.length === 0) return;

        const basePath = `rooms/${roomId}/game`;
        // ì •ë ¬ (timestamp ì˜¤ë¦„ì°¨ìˆœ)
        const sorted = entriesReq.sort((a, b) => {
          const ta = a[1].createdAt || 0;
          const tb = b[1].createdAt || 0;
          return ta - tb;
        });

        // ë¡œì»¬ ê²Œì„ ë³µì‚¬
        const localGame = JSON.parse(JSON.stringify(g));
        const updates = {};
        const logArr = Array.isArray(localGame.skillLog) ? localGame.skillLog : [];

        for (const [reqId, req] of sorted) {
          const { uid, skillId } = req;
          const player = localGame.players[uid];
          if (!player) continue;

          const skillsArr = player.skills || [];
          const idx = skillsArr.indexOf(skillId);
          if (idx === -1) continue; // ì—†ëŠ” ìŠ¤í‚¬ ìš”ì²­ì€ ë¬´ì‹œ

          // ëŒ€ìƒ í”Œë ˆì´ì–´ ê²°ì •
          let targetUid = uid;
          if (skillId.startsWith('opp-')) {
            targetUid = Object.keys(localGame.players).find(x => x !== uid) || uid;
          }

          const targetPlayer = localGame.players[targetUid];
          if (!targetPlayer) continue;

          // í˜„ì¬ ê°’
          let beforeVal = targetPlayer.effectiveCard;
          if (beforeVal === null || beforeVal === undefined) {
            beforeVal = targetPlayer.selectedCard;
          }
          if (beforeVal === null || beforeVal === undefined) continue;

          let storedRandom = undefined;
          if (skillId === 'random') {
            storedRandom = Math.floor(Math.random() * 11); // 0~10
          }

          const afterVal = applySkillValue(beforeVal, skillId, storedRandom);

          // ìŠ¤í‚¬ ì†Œë¹„
          const newSkills = [...skillsArr];
          newSkills.splice(idx, 1);
          localGame.players[uid].skills = newSkills;
          updates[`${basePath}/players/${uid}/skills`] = newSkills;

          // ê°’ ë°˜ì˜
          localGame.players[targetUid].effectiveCard = afterVal;
          updates[`${basePath}/players/${targetUid}/effectiveCard`] = afterVal;

          // ë¡œê·¸ ì¶”ê°€ (ë‹¨ìˆœ)
          logArr.push({
            id: reqId,
            byUid: uid,
            skillId,
            targetUid,
            beforeVal,
            afterVal,
            storedRandom: storedRandom ?? null,
            createdAt: req.createdAt || null
          });
        }

        updates[`${basePath}/skillLog`] = logArr;
        updates[`${basePath}/skillRequests`] = null;

        db.ref().update(updates);
      }, [roomData, roomId, user.uid]);

      // ì¹´ë“œ ì„ íƒ (ìê¸° ê²ƒë§Œ)
      const selectCard = async (card) => {
        if (!game || game.phase !== 'select') return;
        if (!myGame || !myGame.hand || !myGame.hand.includes(card)) return;

        await db
          .ref(`rooms/${roomId}/game/players/${user.uid}/selectedCard`)
          .set(card);
      };

      // ìŠ¤í‚¬ ì‚¬ìš© ìš”ì²­ (ìê¸° ìŠ¤í‚¬ë§Œ, skillRequestsì— ê¸°ë¡ â†’ í˜¸ìŠ¤íŠ¸ê°€ ì²˜ë¦¬)
      const useSkill = async (skillId) => {
        if (!game || game.phase !== 'skill') return;
        if (!myGame || !Array.isArray(myGame.skills)) return;
        if (!myGame.skills.includes(skillId)) return;

        const reqRef = db.ref(`rooms/${roomId}/game/skillRequests`).push();
        await reqRef.set({
          uid: user.uid,
          skillId,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
      };

      // í˜¸ìŠ¤íŠ¸: ê²°ê³¼ í™•ì • (ì ìˆ˜/ìŠ¤í‚¬ ì§€ê¸‰/ë¼ìš´ë“œ ì¢…ë£Œ)
      const resolveRound = async () => {
        if (!roomData || !roomData.game || !roomData.host) return;
        if (roomData.host.uid !== user.uid) return; // í˜¸ìŠ¤íŠ¸ë§Œ
        const g = roomData.game;
        if (g.phase !== 'skill') return;

        const entries = Object.entries(g.players || {});
        if (entries.length < 2) return;

        const basePath = `rooms/${roomId}/game`;
        const [uidA, pA] = entries[0];
        const [uidB, pB] = entries[1];

        const effA = (pA.effectiveCard ?? pA.selectedCard);
        const effB = (pB.effectiveCard ?? pB.selectedCard);
        if (effA === null || effA === undefined || effB === null || effB === undefined) return;

        const winnerUid = getWinnerUid(uidA, effA, uidB, effB);

        const updates = {};
        // ì ìˆ˜
        if (winnerUid) {
          const currentScore = g.players[winnerUid].score || 0;
          updates[`${basePath}/players/${winnerUid}/score`] = currentScore + 1;
        }

        // ì‚¬ìš©í•œ ì¹´ë“œ ì œê±°
        const newHandA = (pA.hand || []).filter(c => c !== pA.selectedCard);
        const newHandB = (pB.hand || []).filter(c => c !== pB.selectedCard);
        updates[`${basePath}/players/${uidA}/hand`] = newHandA;
        updates[`${basePath}/players/${uidB}/hand`] = newHandB;

        // ì„ íƒ/íš¨ê³¼ ê°’ ì´ˆê¸°í™” (ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´)
        updates[`${basePath}/players/${uidA}/selectedCard`] = null;
        updates[`${basePath}/players/${uidB}/selectedCard`] = null;
        updates[`${basePath}/players/${uidA}/effectiveCard`] = null;
        updates[`${basePath}/players/${uidB}/effectiveCard`] = null;

        // ìŠ¤í‚¬ ì§€ê¸‰ ë¡œì§
        const giveSkill = (uid, count) => {
          if (!uid || count <= 0) return;
          const curSkills = Array.isArray(g.players[uid].skills) ? g.players[uid].skills : [];
          const newSkills = [...curSkills];
          for (let i = 0; i < count; i++) newSkills.push(randomSkillId());
          updates[`${basePath}/players/${uid}/skills`] = newSkills;
        };

        const isTenVsZero =
          (effA === 10 && effB === 0) || (effA === 0 && effB === 10);
        const diff = Math.abs(effA - effB);

        if (winnerUid) {
          if (isTenVsZero) {
            giveSkill(winnerUid, 2);
          } else if (diff === 1) {
            giveSkill(winnerUid, 1);
          }
        } else {
          // ë¬´ìŠ¹ë¶€ â†’ ë‘˜ ë‹¤ 1ê°œ
          giveSkill(uidA, 1);
          giveSkill(uidB, 1);
        }

        // lastResult ì €ì¥ (ì„ íƒê°’ + ìµœì¢…ê°’)
        const lastResult = {
          [uidA]: { selected: pA.selectedCard, effective: effA },
          [uidB]: { selected: pB.selectedCard, effective: effB },
          winnerUid,
          round: g.currentRound
        };
        updates[`${basePath}/lastResult`] = lastResult;
        updates[`${basePath}/phase`] = 'result';

        await db.ref().update(updates);
      };

      // ë‹¤ìŒ ë¼ìš´ë“œ or ê²Œì„ ì¢…ë£Œ (í˜¸ìŠ¤íŠ¸ë§Œ)
      const nextRoundOrFinish = async () => {
        if (!roomData || !roomData.game || !roomData.host) return;
        if (roomData.host.uid !== user.uid) return;
        const g = roomData.game;
        if (g.phase !== 'result') return;

        const basePath = `rooms/${roomId}/game`;
        const entries = Object.entries(g.players || {});
        if (entries.length < 2) return;
        const [uidA, pA] = entries[0];
        const [uidB, pB] = entries[1];

        const handsEmpty =
          (pA.hand?.length || 0) === 0 ||
          (pB.hand?.length || 0) === 0;
        const isLastRound = g.currentRound >= g.maxRounds;

        if (handsEmpty || isLastRound) {
          await db.ref(basePath).update({
            phase: 'finished'
          });
          return;
        }

        const updates = {};
        updates[`${basePath}/currentRound`] = g.currentRound + 1;
        updates[`${basePath}/phase`] = 'select';
        updates[`${basePath}/lastResult`] = null;
        updates[`${basePath}/skillLog`] = g.skillLog || null; // ë¡œê·¸ëŠ” ìœ ì§€

        await db.ref().update(updates);
      };

      const handleExitGame = async () => {
        if (roomId) {
          const roomRef = db.ref(`rooms/${roomId}`);
          const snap = await roomRef.get();
          if (snap.exists()) {
            const data = snap.val();
            const amIHost = data.host && data.host.uid === user.uid;
            if (amIHost) {
              await roomRef.remove();
            } else {
              await roomRef.child(`players/${user.uid}`).remove();
            }
          }
        }
        onExit();
      };

      const phase = game.phase;
      const last = game.lastResult;

      let statusText = '';
      if (phase === 'select') {
        if (!myGame?.selectedCard && (myGame?.hand?.length || 0) > 0) statusText = 'ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”';
        else statusText = 'ìƒëŒ€ê°€ ì¹´ë“œë¥¼ ì„ íƒí•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...';
      } else if (phase === 'skill') {
        statusText = 'ìŠ¤í‚¬ì„ ì‚¬ìš©í•´ì„œ ìˆ«ìë¥¼ ì¡°ì •í•˜ì„¸ìš”';
      } else if (phase === 'result' && last) {
        if (!last.winnerUid) statusText = 'ì´ ë¼ìš´ë“œ ë¬´ìŠ¹ë¶€!';
        else if (last.winnerUid === user.uid) statusText = 'ì´ ë¼ìš´ë“œ ìŠ¹ë¦¬!';
        else statusText = 'ì´ ë¼ìš´ë“œ íŒ¨ë°°...';
      } else if (phase === 'finished') {
        const myScore = myGame?.score || 0;
        const oppScore = oppGame?.score || 0;
        if (myScore > oppScore) statusText = 'ê²Œì„ ìŠ¹ë¦¬!';
        else if (myScore < oppScore) statusText = 'ê²Œì„ íŒ¨ë°°...';
        else statusText = 'ë¬´ìŠ¹ë¶€ë¡œ ì¢…ë£Œ!';
      }

      const renderCard = (value, selected, disabled, onClick) => (
        <button
          key={value}
          disabled={disabled}
          onClick={onClick}
          className={
            `w-12 h-16 sm:w-14 sm:h-20 rounded-lg border-2 text-lg sm:text-xl font-bold flex items-center justify-center 
             transition-transform active:scale-95 mr-1 mb-1
             ${selected ? 'border-yellow-400 bg-slate-100 text-slate-900' : 'border-slate-600 bg-slate-800 text-white'}
             ${disabled ? 'opacity-40 cursor-not-allowed' : 'hover:border-blue-400'}`
          }
        >
          {value}
        </button>
      );

      const mySkills = Array.isArray(myGame?.skills) ? myGame.skills : [];

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-900 animate-fade-in">
          <div className="w-full max-w-3xl glass rounded-3xl p-4 sm:p-6 shadow-2xl flex flex-col gap-4">
            {/* ìƒë‹¨: ìƒëŒ€ ì •ë³´ & ìŠ¤ì½”ì–´ */}
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-lg font-bold border border-slate-600">
                  {oppInfo ? oppInfo.name[0] : '?'}
                </div>
                <div>
                  <div className="text-xs text-slate-500">ìƒëŒ€</div>
                  <div className="font-bold text-white text-sm">{oppInfo?.name ?? 'ëŒ€ê¸° ì¤‘'}</div>
                </div>
              </div>
              <div className="text-center">
                <div className="text-xs text-slate-500 mb-1">ROUND</div>
                <div className="text-lg font-bold text-yellow-300">
                  {game.currentRound} / {game.maxRounds}
                </div>
              </div>
              <div className="flex flex-col items-end text-xs text-slate-400">
                <div>
                  {myInfo?.name}: <span className="text-blue-400 font-bold">{myGame?.score ?? 0}</span>
                </div>
                <div>
                  {oppInfo?.name ?? 'ìƒëŒ€'}: <span className="text-red-400 font-bold">{oppGame?.score ?? 0}</span>
                </div>
              </div>
            </div>

            {/* ì¤‘ì•™: ìƒíƒœ ë©”ì‹œì§€ / ê²°ê³¼ */}
            <div className="text-center py-2">
              <p className="font-bold text-lg text-white mb-1">{statusText}</p>
              {phase === 'result' && last && oppUid && (
                <div className="text-sm text-slate-400">
                  {myInfo?.name} [{last[user.uid]?.effective}] vs {oppInfo?.name} [{last[oppUid]?.effective}]
                </div>
              )}
            </div>

            {/* ì¤‘ì•™: ë³´ë“œ (ì¹´ë“œ ë³´ì—¬ì£¼ê¸°) */}
            <div className="flex justify-center gap-8 items-center py-2">
              <div className="flex flex-col items-center">
                <div className="text-xs text-slate-400 mb-1">ìƒëŒ€ ì¹´ë“œ</div>
                <div className="w-12 h-16 sm:w-14 sm:h-20 rounded-lg border-2 border-slate-700 bg-slate-800 flex items-center justify-center text-xl font-bold">
                  {phase === 'skill' || phase === 'result' || phase === 'finished'
                    ? (oppGame?.effectiveCard ?? oppGame?.selectedCard ?? '?')
                    : '?'}
                </div>
              </div>
              <div className="flex flex-col items-center">
                <div className="text-xs text-slate-400 mb-1">ë‚´ ì¹´ë“œ</div>
                <div className="w-12 h-16 sm:w-14 sm:h-20 rounded-lg border-2 border-blue-400 bg-slate-100 flex items-center justify-center text-xl font-bold text-slate-900">
                  {myGame?.effectiveCard ?? myGame?.selectedCard ?? '-'}
                </div>
              </div>
            </div>

            {/* ë‚´ ìŠ¤í‚¬ */}
            <div>
              <div className="text-xs text-slate-400 mb-1">ë‚´ ìŠ¤í‚¬</div>
              {mySkills.length === 0 ? (
                <div className="text-slate-500 text-sm">ë³´ìœ  ìŠ¤í‚¬ ì—†ìŒ</div>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {mySkills.map((skillId, idx) => {
                    const def = SKILL_DEFS[skillId] || { name: skillId, color: 'bg-slate-600' };
                    return (
                      <button
                        key={idx}
                        disabled={phase !== 'skill'}
                        onClick={() => useSkill(skillId)}
                        className={`px-3 py-1 rounded-full text-xs font-bold ${def.color} disabled:opacity-40 disabled:cursor-not-allowed`}
                      >
                        {def.name}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>

            {/* ë‚´ ì†íŒ¨ */}
            <div>
              <div className="text-xs text-slate-400 mb-1">ë‚´ ì†íŒ¨</div>
              <div className="flex flex-wrap">
                {(myGame?.hand ?? []).map(card =>
                  renderCard(
                    card,
                    myGame?.selectedCard === card,
                    phase !== 'select',
                    () => selectCard(card)
                  )
                )}
                {(!myGame?.hand || myGame.hand.length === 0) && (
                  <div className="text-slate-500 text-sm">ì†íŒ¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                )}
              </div>
            </div>

            {/* í•˜ë‹¨ ë²„íŠ¼ */}
            <div className="flex justify-between items-center pt-2">
              <button
                onClick={handleExitGame}
                className="px-4 py-2 text-xs sm:text-sm text-slate-400 hover:text-white"
              >
                ê²Œì„ ì¢…ë£Œ & ë°© ë‚˜ê°€ê¸°
              </button>

              {phase === 'skill' && isHost && (
                <button
                  onClick={resolveRound}
                  className="px-5 py-2 bg-yellow-500 hover:bg-yellow-400 rounded-xl text-black font-bold text-xs sm:text-sm"
                >
                  ê²°ê³¼ í™•ì •
                </button>
              )}

              {phase === 'result' && isHost && (
                <button
                  onClick={nextRoundOrFinish}
                  className="px-5 py-2 bg-yellow-500 hover:bg-yellow-400 rounded-xl text-black font-bold text-xs sm:text-sm"
                >
                  {game.currentRound >= game.maxRounds ||
                  (myGame?.hand?.length === 0 || oppGame?.hand?.length === 0)
                    ? 'ê²Œì„ ê²°ê³¼ í™•ì •'
                    : 'ë‹¤ìŒ ë¼ìš´ë“œ'}
                </button>
              )}

              {phase === 'finished' && (
                <button
                  onClick={handleExitGame}
                  className="px-5 py-2 bg-red-600 hover:bg-red-500 rounded-xl text-white font-bold text-xs sm:text-sm"
                >
                  ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>