<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Zero Point: PVP</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #1a3a1a 0%, #0d1f0d 100%);
      color: white;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* í¬ì»¤ í…Œì´ë¸” ëŠë‚Œ */
    .poker-table {
      background: radial-gradient(ellipse at center, #1e5631 0%, #143d22 60%, #0d2818 100%);
      border: 8px solid #5d3a1a;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.5), 0 10px 30px rgba(0,0,0,0.5);
    }

    .wood-border {
      background: linear-gradient(180deg, #8b5a2b 0%, #5d3a1a 50%, #3d2510 100%);
      border: 2px solid #2d1810;
    }

    /* í¬ì»¤ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .poker-card {
      background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
      border-radius: 8px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.3), inset 0 0 20px rgba(255,255,255,0.5);
      position: relative;
      font-family: 'Georgia', serif;
    }
    .poker-card::before {
      content: '';
      position: absolute;
      inset: 3px;
      border: 1px solid #ddd;
      border-radius: 5px;
      pointer-events: none;
    }
    .poker-card.card-back {
      background: linear-gradient(145deg, #8b0000 0%, #4a0000 100%);
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(255,255,255,0.05) 10px,
        rgba(255,255,255,0.05) 20px
      );
    }
    .poker-card.selected {
      transform: translateY(-8px);
      box-shadow: 0 12px 20px rgba(0,0,0,0.4), 0 0 20px rgba(255,215,0,0.5);
      border: 3px solid gold;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-pulse-glow { animation: pulseGlow 1.5s infinite; }
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(255,215,0,0.5); }
      50% { box-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 30px rgba(255,215,0,0.4); }
    }

    .animate-shake { animation: shake 0.5s ease-in-out; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    @keyframes bounceIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }

    .animate-flash { animation: flash 0.3s ease-out; }
    @keyframes flash {
      0% { background-color: rgba(255,255,255,0.8); }
      100% { background-color: transparent; }
    }

    /* ìŠ¤í‚¬ ì´í™íŠ¸ */
    .skill-effect {
      position: absolute;
      pointer-events: none;
      z-index: 100;
    }
    .effect-plus { color: #22c55e; font-size: 2rem; font-weight: bold; animation: floatUp 1s forwards; }
    .effect-minus { color: #ef4444; font-size: 2rem; font-weight: bold; animation: floatUp 1s forwards; }
    .effect-double { color: #eab308; font-size: 2rem; font-weight: bold; animation: zoomPulse 0.8s forwards; }
    .effect-random { color: #a855f7; font-size: 2rem; animation: spin 0.8s forwards; }
    .effect-retrieve { color: #3b82f6; font-size: 2rem; animation: spiral 1s forwards; }
    .effect-nullify { color: #dc2626; font-size: 2.5rem; animation: stamp 0.6s forwards; }

    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
    }
    @keyframes zoomPulse {
      0% { opacity: 1; transform: scale(1); }
      50% { transform: scale(1.5); }
      100% { opacity: 0; transform: scale(2); }
    }
    @keyframes spin {
      0% { opacity: 1; transform: rotate(0deg) scale(1); }
      100% { opacity: 0; transform: rotate(720deg) scale(0); }
    }
    @keyframes spiral {
      0% { opacity: 1; transform: rotate(0deg) translateY(0); }
      100% { opacity: 0; transform: rotate(360deg) translateY(-30px); }
    }
    @keyframes stamp {
      0% { opacity: 0; transform: scale(3); }
      50% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1); }
    }

    /* íƒ€ì´ë¨¸ ë°” */
    .timer-bar {
      height: 4px;
      background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
      transition: width 0.1s linear;
    }

    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

    /* ìŠ¤í‚¬ ë²„íŠ¼ */
    .skill-btn {
      transition: all 0.2s;
    }
    .skill-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .skill-btn:active:not(:disabled) {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAy9neN8_-8HWZNcQluP6jGbzNQMICWc6s",
      authDomain: "zero-pvp.firebaseapp.com",
      projectId: "zero-pvp",
      storageBucket: "zero-pvp.firebasestorage.app",
      messagingSenderId: "634718710928",
      appId: "1:634718710928:web:b5339abd5d443c1ca83c15",
      databaseURL: "https://zero-pvp-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ìŠ¹ë¶€ íŒë‹¨ (ì‘ì€ ìˆ«ì ìŠ¹ë¦¬, 10ì€ 0ì„ ì´ê¹€)
    const getWinnerUid = (uidA, cardA, uidB, cardB) => {
      if (cardA === cardB) return null;
      if (cardA === 10 && cardB === 0) return uidA;
      if (cardB === 10 && cardA === 0) return uidB;
      return cardA < cardB ? uidA : uidB;
    };

    // ìŠ¤í‚¬ ì •ì˜
    const SKILL_DEFS = {
      'self-plus':  { id: 'self-plus',  name: 'ë³¸ì¸+1',  icon: '+1', color: 'bg-emerald-600', desc: 'ë‚´ ì¹´ë“œ +1 (10â†’0)' },
      'self-minus': { id: 'self-minus', name: 'ë³¸ì¸-1',  icon: '-1', color: 'bg-emerald-500', desc: 'ë‚´ ì¹´ë“œ -1 (0â†’10)' },
      'opp-plus':   { id: 'opp-plus',   name: 'ìƒëŒ€+1',  icon: '+1', color: 'bg-red-600', desc: 'ìƒëŒ€ ì¹´ë“œ +1' },
      'opp-minus':  { id: 'opp-minus',  name: 'ìƒëŒ€-1',  icon: '-1', color: 'bg-red-500', desc: 'ìƒëŒ€ ì¹´ë“œ -1' },
      'double':     { id: 'double',     name: '2ë°°',     icon: 'x2', color: 'bg-yellow-600', desc: 'ë‚´ ì¹´ë“œ x2 (10ì´ˆê³¼ì‹œ ì¼ì˜ìë¦¬)' },
      'random':     { id: 'random',     name: 'ëœë¤',    icon: '?',  color: 'bg-purple-600', desc: 'ë‚´ ì¹´ë“œë¥¼ 0~10 ëœë¤ìœ¼ë¡œ' },
      'retrieve':   { id: 'retrieve',   name: 'íšŒìˆ˜',    icon: 'â†©', color: 'bg-blue-600', desc: 'ì´ë²ˆ í„´ ì¹´ë“œ íšŒìˆ˜, í„´ ë¦¬ì…‹' },
      'nullify':    { id: 'nullify',    name: 'ë¬´ë ¥í™”',  icon: 'âœ•', color: 'bg-gray-700', desc: 'ìƒëŒ€ê°€ ì‚¬ìš©í•œ ìŠ¤í‚¬ 1ê°œ ì·¨ì†Œ' }
    };
    const SKILL_IDS = Object.keys(SKILL_DEFS);
    const randomSkillId = () => SKILL_IDS[Math.floor(Math.random() * SKILL_IDS.length)];

    // ìŠ¤í‚¬ íš¨ê³¼ ì ìš©
    const applySkillValue = (val, skillId, storedRandom) => {
      if (val === null || val === undefined) return val;
      let v = Number(val);
      if (isNaN(v)) return val;

      switch (skillId) {
        case 'self-plus':
        case 'opp-plus':
          return v + 1 > 10 ? 0 : v + 1;
        case 'self-minus':
        case 'opp-minus':
          return v - 1 < 0 ? 10 : v - 1;
        case 'double': {
          let doubled = Math.floor(v) * 2;
          return doubled > 10 ? doubled % 10 : doubled;
        }
        case 'random':
          return storedRandom !== undefined ? storedRandom : v;
        default:
          return v;
      }
    };

    // ==================== App ====================
    const App = () => {
      const [user, setUser] = useState(null);
      const [screen, setScreen] = useState('menu');
      const [playerName, setPlayerName] = useState('');
      const [currentRoomId, setCurrentRoomId] = useState(null);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          if (u) setUser(u);
          else auth.signInAnonymously();
        });
        return () => unsub();
      }, []);

      const handleExitToLobby = useCallback(() => {
        setScreen('lobby');
        setCurrentRoomId(null);
      }, []);

      if (!user) {
        return (
          <div className="min-h-screen flex items-center justify-center text-amber-200">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              ì„œë²„ ì—°ê²° ì¤‘...
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          {screen === 'menu' && (
            <MenuScreen onStart={(name) => { setPlayerName(name); setScreen('lobby'); }} />
          )}
          {screen === 'lobby' && (
            <LobbyScreen
              user={user}
              playerName={playerName}
              onBack={() => setScreen('menu')}
              onJoinRoom={(roomId) => { setCurrentRoomId(roomId); setScreen('room'); }}
            />
          )}
          {screen === 'room' && (
            <WaitingRoom
              user={user}
              playerName={playerName}
              roomId={currentRoomId}
              onGameStart={() => setScreen('game')}
              onLeave={handleExitToLobby}
            />
          )}
          {screen === 'game' && (
            <GameScreen user={user} roomId={currentRoomId} onExit={handleExitToLobby} />
          )}
        </div>
      );
    };

    // ==================== Menu ====================
    const MenuScreen = ({ onStart }) => {
      const [name, setName] = useState('');

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 animate-fade-in">
          <div className="text-center mb-10">
            <h1 className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 via-yellow-500 to-amber-700 mb-2" style={{textShadow: '0 4px 8px rgba(0,0,0,0.5)'}}>
              ZERO
            </h1>
            <p className="text-amber-200/80 text-lg tracking-[0.5em] uppercase">Point PvP</p>
          </div>

          <div className="wood-border rounded-2xl p-1">
            <div className="poker-table rounded-xl p-8 w-80">
              <div className="text-center mb-6">
                <p className="text-amber-200/60 text-sm mb-2">ë‹‰ë„¤ì„ ì…ë ¥</p>
                <input
                  type="text"
                  value={name}
                  onChange={e => setName(e.target.value)}
                  placeholder="2~8ì"
                  maxLength={8}
                  className="w-full px-4 py-3 bg-black/30 rounded-lg text-center text-white text-xl outline-none border-2 border-amber-900/50 focus:border-amber-500 transition-colors"
                />
              </div>
              <button
                onClick={() => name.trim().length >= 2 && onStart(name.trim())}
                disabled={name.trim().length < 2}
                className="w-full py-4 bg-gradient-to-b from-amber-500 to-amber-700 rounded-lg font-bold text-lg text-white shadow-lg disabled:opacity-40 disabled:cursor-not-allowed hover:from-amber-400 hover:to-amber-600 transition-all active:scale-95"
              >
                ê²Œì„ ì…ì¥
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ==================== Lobby ====================
    const LobbyScreen = ({ user, playerName, onBack, onJoinRoom }) => {
      const [rooms, setRooms] = useState([]);

      useEffect(() => {
        const roomsRef = db.ref('rooms');
        const listener = roomsRef.on('value', (snapshot) => {
          const data = snapshot.val();
          const list = [];
          const now = Date.now();
          const EXPIRE_MS = 5 * 60 * 1000;

          if (data) {
            Object.entries(data).forEach(([roomId, room]) => {
              if (room.status === 'waiting' && room.createdAt && (now - room.createdAt) > EXPIRE_MS) {
                db.ref(`rooms/${roomId}`).remove();
                return;
              }
              if (!room.players || Object.keys(room.players).length === 0) return;
              if (!room.host || !room.host.uid) return;
              if (room.status !== 'waiting') return;
              list.push({ id: roomId, ...room });
            });
          }
          list.sort((a, b) => b.createdAt - a.createdAt);
          setRooms(list);
        });
        return () => roomsRef.off('value', listener);
      }, []);

      const createRoom = async () => {
        const roomRef = db.ref('rooms').push();
        await roomRef.set({
          status: 'waiting',
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          host: { uid: user.uid, name: playerName },
          settings: { maxRounds: 3 }
        });
        await roomRef.child(`players/${user.uid}`).set({ name: playerName, ready: false });
        roomRef.child(`players/${user.uid}`).onDisconnect().remove();
        onJoinRoom(roomRef.key);
      };

      const joinRoom = async (roomId) => {
        const roomRef = db.ref(`rooms/${roomId}`);
        const snap = await roomRef.get();
        if (!snap.exists()) return alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
        const room = snap.val();
        if (Object.keys(room.players || {}).length >= 2) return alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");

        await roomRef.child(`players/${user.uid}`).set({ name: playerName, ready: false });
        roomRef.child(`players/${user.uid}`).onDisconnect().remove();
        onJoinRoom(roomId);
      };

      return (
        <div className="min-h-screen p-4 animate-fade-in">
          <div className="max-w-2xl mx-auto">
            <header className="flex justify-between items-center py-4 mb-6">
              <button onClick={onBack} className="text-amber-200/60 hover:text-amber-200">â† ë‚˜ê°€ê¸°</button>
              <h2 className="text-2xl font-bold text-amber-200">LOBBY</h2>
              <div className="w-16"></div>
            </header>

            <div className="wood-border rounded-2xl p-1 mb-6">
              <div className="poker-table rounded-xl p-6 flex justify-between items-center">
                <div>
                  <p className="text-amber-200/60 text-xs">PLAYER</p>
                  <p className="text-xl font-bold text-amber-200">{playerName}</p>
                </div>
                <button onClick={createRoom} className="px-6 py-3 bg-gradient-to-b from-amber-500 to-amber-700 rounded-lg font-bold text-white hover:from-amber-400 hover:to-amber-600 active:scale-95 transition-all">
                  + ë°© ë§Œë“¤ê¸°
                </button>
              </div>
            </div>

            <div className="space-y-3">
              {rooms.length === 0 ? (
                <div className="text-center py-10 text-amber-200/40">ëŒ€ê¸° ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
              ) : rooms.map(room => (
                <div key={room.id} className="wood-border rounded-xl p-1">
                  <div className="poker-table rounded-lg p-4 flex justify-between items-center">
                    <div>
                      <p className="font-bold text-amber-200">{room.host.name}ì˜ ë°©</p>
                      <p className="text-xs text-amber-200/50">#{room.id.slice(-4)} Â· {room.settings?.maxRounds || 3}ë¼ìš´ë“œ</p>
                    </div>
                    <button onClick={() => joinRoom(room.id)} className="px-5 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-bold text-white transition-colors">
                      ì…ì¥
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ==================== Waiting Room ====================
    const WaitingRoom = ({ user, playerName, roomId, onLeave, onGameStart }) => {
      const [roomData, setRoomData] = useState(null);
      const [selectedRounds, setSelectedRounds] = useState(3);

      useEffect(() => {
        const roomRef = db.ref(`rooms/${roomId}`);
        const listener = roomRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (!data) { alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); onLeave(); return; }
          setRoomData(data);
          if (data.settings?.maxRounds) setSelectedRounds(data.settings.maxRounds);
          if (data.status === 'playing') onGameStart();
        });
        return () => roomRef.off('value', listener);
      }, [roomId, onLeave, onGameStart]);

      const handleLeave = async () => {
        if (!roomData) { onLeave(); return; }
        const isHost = roomData.host?.uid === user.uid;
        if (isHost) await db.ref(`rooms/${roomId}`).remove();
        else await db.ref(`rooms/${roomId}/players/${user.uid}`).remove();
        onLeave();
      };

      const toggleReady = async () => {
        if (!roomData?.players?.[user.uid]) return;
        await db.ref(`rooms/${roomId}/players/${user.uid}/ready`).set(!roomData.players[user.uid].ready);
      };

      const updateRounds = async (rounds) => {
        setSelectedRounds(rounds);
        await db.ref(`rooms/${roomId}/settings/maxRounds`).set(rounds);
      };

      const startGame = async () => {
        await db.ref(`rooms/${roomId}`).update({
          status: 'playing',
          startedAt: firebase.database.ServerValue.TIMESTAMP
        });
      };

      if (!roomData?.players?.[user.uid]) {
        return <div className="min-h-screen flex items-center justify-center text-amber-200">ë¡œë”© ì¤‘...</div>;
      }

      const me = roomData.players[user.uid];
      const isHost = roomData.host?.uid === user.uid;
      const players = Object.entries(roomData.players);
      const opponentEntry = players.find(([uid]) => uid !== user.uid);
      const opponent = opponentEntry ? opponentEntry[1] : null;
      const canStart = opponent && me.ready && opponent.ready;

      return (
        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in">
          <div className="wood-border rounded-3xl p-2 w-full max-w-lg">
            <div className="poker-table rounded-2xl p-8">
              <h2 className="text-2xl font-bold text-amber-200 text-center mb-2">ëŒ€ê¸°ì‹¤</h2>
              <p className="text-center text-amber-200/50 text-xs mb-8">Room #{roomId.slice(-4)}</p>

              {/* ë¼ìš´ë“œ ì„ íƒ (ë°©ì¥ë§Œ) */}
              {isHost && (
                <div className="mb-6 text-center">
                  <p className="text-amber-200/60 text-sm mb-2">ë¼ìš´ë“œ ìˆ˜</p>
                  <div className="flex justify-center gap-2">
                    {[3, 4, 5].map(n => (
                      <button
                        key={n}
                        onClick={() => updateRounds(n)}
                        className={`w-12 h-12 rounded-lg font-bold text-lg transition-all ${
                          selectedRounds === n
                            ? 'bg-amber-500 text-white'
                            : 'bg-black/30 text-amber-200/60 hover:bg-black/50'
                        }`}
                      >
                        {n}
                      </button>
                    ))}
                  </div>
                </div>
              )}
              {!isHost && (
                <p className="text-center text-amber-200/60 mb-6">{selectedRounds}ë¼ìš´ë“œ ê²Œì„</p>
              )}

              {/* í”Œë ˆì´ì–´ í‘œì‹œ */}
              <div className="flex justify-between items-center mb-8">
                <PlayerSlot player={me} isReady={me.ready} label="ë‚˜" />
                <span className="text-3xl font-black text-amber-900/50 italic">VS</span>
                {opponent ? (
                  <PlayerSlot player={opponent} isReady={opponent.ready} label="" />
                ) : (
                  <div className="flex flex-col items-center">
                    <div className="w-20 h-20 rounded-full bg-black/30 border-4 border-dashed border-amber-900/50 flex items-center justify-center animate-pulse text-3xl text-amber-900/50">?</div>
                    <span className="text-amber-200/50 text-sm mt-2">ëŒ€ê¸° ì¤‘...</span>
                  </div>
                )}
              </div>

              {/* ë²„íŠ¼ */}
              <div className="space-y-3">
                {isHost ? (
                  <button
                    onClick={startGame}
                    disabled={!canStart}
                    className={`w-full py-4 rounded-xl font-black text-lg transition-all ${
                      canStart ? 'bg-gradient-to-b from-emerald-500 to-emerald-700 text-white animate-pulse-glow hover:from-emerald-400' : 'bg-black/30 text-amber-200/40 cursor-not-allowed'
                    }`}
                  >
                    {canStart ? 'ê²Œì„ ì‹œì‘!' : 'ëª¨ë‘ ì¤€ë¹„ í•„ìš”'}
                  </button>
                ) : null}
                <button
                  onClick={toggleReady}
                  className={`w-full py-3 rounded-xl font-bold transition-all ${
                    me.ready ? 'bg-gray-600 text-gray-300' : 'bg-blue-600 text-white hover:bg-blue-500'
                  }`}
                >
                  {me.ready ? 'ì¤€ë¹„ ì·¨ì†Œ' : 'ì¤€ë¹„ ì™„ë£Œ'}
                </button>
                <button onClick={handleLeave} className="w-full py-2 text-amber-200/50 hover:text-amber-200 text-sm">
                  ë‚˜ê°€ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const PlayerSlot = ({ player, isReady, label }) => (
      <div className="flex flex-col items-center">
        <div className={`w-20 h-20 rounded-full flex items-center justify-center text-2xl font-black border-4 transition-all ${
          isReady ? 'border-emerald-500 bg-emerald-900/50 text-emerald-400' : 'border-amber-600 bg-black/30 text-amber-200'
        }`}>
          {player.name[0]}
        </div>
        <span className="text-amber-200 font-bold mt-2">{player.name}{label ? ` ${label}` : ''}</span>
        <span className={`text-xs px-2 py-1 rounded mt-1 ${isReady ? 'bg-emerald-600 text-white' : 'bg-black/30 text-amber-200/50'}`}>
          {isReady ? 'READY' : 'WAITING'}
        </span>
      </div>
    );

    // ==================== Game Screen ====================
    const GameScreen = ({ user, roomId, onExit }) => {
      const [roomData, setRoomData] = useState(null);
      const [isInitializing, setIsInitializing] = useState(false);
      const [timer, setTimer] = useState(10);
      const [effects, setEffects] = useState([]);
      const [nullifyTarget, setNullifyTarget] = useState(null);
      const onExitRef = useRef(onExit);
      const timerRef = useRef(null);

      useEffect(() => { onExitRef.current = onExit; }, [onExit]);

      // ì‹¤ì‹œê°„ êµ¬ë…
      useEffect(() => {
        const roomRef = db.ref(`rooms/${roomId}`);
        const listener = roomRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (!data) { alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); onExitRef.current(); return; }
          setRoomData(data);
        });
        return () => roomRef.off('value', listener);
      }, [roomId]);

      // í˜¸ìŠ¤íŠ¸: ê²Œì„ ì´ˆê¸°í™”
      useEffect(() => {
        if (!roomData?.host || !roomData?.players) return;
        if (roomData.host.uid !== user.uid) return;
        if (roomData.game) return;
        if (isInitializing) return;

        const initGame = async () => {
          setIsInitializing(true);
          const gamePlayers = {};
          Object.entries(roomData.players).forEach(([uid, p]) => {
            gamePlayers[uid] = {
              score: 0,
              hand: [0,1,2,3,4,5,6,7,8,9,10],
              selectedCard: null,
              originalCard: null,
              effectiveCard: null,
              skills: [randomSkillId(), randomSkillId()],
              ready: false
            };
          });
          await db.ref(`rooms/${roomId}/game`).set({
            maxRounds: roomData.settings?.maxRounds || 3,
            currentRound: 1,
            currentTurn: 1,
            phase: 'select',
            lastResult: null,
            skillLog: [],
            players: gamePlayers
          });
          setIsInitializing(false);
        };
        initGame();
      }, [roomData, roomId, user.uid, isInitializing]);

      // í˜¸ìŠ¤íŠ¸: ë‘˜ ë‹¤ ì¹´ë“œ ì„ íƒ â†’ skill í˜ì´ì¦ˆ
      useEffect(() => {
        if (!roomData?.game || !roomData?.host) return;
        if (roomData.host.uid !== user.uid) return;
        if (roomData.game.phase !== 'select') return;

        const entries = Object.entries(roomData.game.players || {});
        if (entries.length < 2) return;
        const allSelected = entries.every(([uid, p]) => p.selectedCard !== null && p.selectedCard !== undefined);
        if (!allSelected) return;

        const basePath = `rooms/${roomId}/game`;
        const updates = {};
        entries.forEach(([uid, p]) => {
          updates[`${basePath}/players/${uid}/effectiveCard`] = p.selectedCard;
          updates[`${basePath}/players/${uid}/originalCard`] = p.selectedCard;
        });
        updates[`${basePath}/phase`] = 'skill';
        updates[`${basePath}/skillLog`] = [];
        updates[`${basePath}/skillPhaseStart`] = firebase.database.ServerValue.TIMESTAMP;

        db.ref().update(updates);
      }, [roomData, roomId, user.uid]);

      // ìŠ¤í‚¬ í˜ì´ì¦ˆ íƒ€ì´ë¨¸
      useEffect(() => {
        if (!roomData?.game || roomData.game.phase !== 'skill') {
          setTimer(10);
          if (timerRef.current) clearInterval(timerRef.current);
          return;
        }

        setTimer(10);
        timerRef.current = setInterval(() => {
          setTimer(prev => {
            if (prev <= 1) {
              clearInterval(timerRef.current);
              return 0;
            }
            return prev - 1;
          });
        }, 1000);

        return () => { if (timerRef.current) clearInterval(timerRef.current); };
      }, [roomData?.game?.phase, roomData?.game?.currentTurn]);

      // íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ìë™ ê²°ê³¼ í™•ì • (í˜¸ìŠ¤íŠ¸ë§Œ)
      useEffect(() => {
        if (timer === 0 && roomData?.game?.phase === 'skill' && roomData?.host?.uid === user.uid) {
          resolveRound();
        }
      }, [timer]);

      // ì´í™íŠ¸ ì¶”ê°€ í•¨ìˆ˜
      const addEffect = (type, targetUid) => {
        const id = Date.now();
        setEffects(prev => [...prev, { id, type, targetUid }]);
        setTimeout(() => setEffects(prev => prev.filter(e => e.id !== id)), 1000);
      };

      // ì¹´ë“œ ì„ íƒ
      const selectCard = async (card) => {
        if (!roomData?.game || roomData.game.phase !== 'select') return;
        const myGame = roomData.game.players?.[user.uid];
        if (!myGame || !myGame.hand?.includes(card)) return;
        await db.ref(`rooms/${roomId}/game/players/${user.uid}/selectedCard`).set(card);
      };

      // ìŠ¤í‚¬ ì‚¬ìš©
      const useSkill = async (skillId, skillIndex) => {
        if (!roomData?.game || roomData.game.phase !== 'skill') return;
        const myGame = roomData.game.players?.[user.uid];
        if (!myGame || !myGame.skills?.[skillIndex]) return;
        if (timer <= 0) return;

        const isHost = roomData.host.uid === user.uid;
        const basePath = `rooms/${roomId}/game`;
        const oppUid = Object.keys(roomData.game.players).find(uid => uid !== user.uid);

        // íšŒìˆ˜ ìŠ¤í‚¬
        if (skillId === 'retrieve') {
          addEffect('retrieve', user.uid);
          const updates = {};
          Object.keys(roomData.game.players).forEach(uid => {
            const p = roomData.game.players[uid];
            updates[`${basePath}/players/${uid}/selectedCard`] = null;
            updates[`${basePath}/players/${uid}/effectiveCard`] = null;
            updates[`${basePath}/players/${uid}/originalCard`] = null;
          });
          updates[`${basePath}/phase`] = 'select';
          updates[`${basePath}/skillLog`] = [...(roomData.game.skillLog || []), {
            id: Date.now(),
            byUid: user.uid,
            byName: roomData.players[user.uid].name,
            skillId: 'retrieve',
            desc: `${roomData.players[user.uid].name}ì´(ê°€) íšŒìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í„´ì„ ë¦¬ì…‹í–ˆìŠµë‹ˆë‹¤.`
          }];

          // ìŠ¤í‚¬ ì†Œë¹„
          const newSkills = [...myGame.skills];
          newSkills.splice(skillIndex, 1);
          updates[`${basePath}/players/${user.uid}/skills`] = newSkills;

          await db.ref().update(updates);
          return;
        }

        // ë¬´ë ¥í™” ìŠ¤í‚¬ - íƒ€ê²Ÿ ì„ íƒ ëª¨ë“œ
        if (skillId === 'nullify') {
          const oppLogs = (roomData.game.skillLog || []).filter(
            log => log.byUid === oppUid && !log.nullified && log.skillId !== 'retrieve' && log.skillId !== 'nullify'
          );
          if (oppLogs.length === 0) {
            alert('ë¬´ë ¥í™”í•  ìƒëŒ€ ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          setNullifyTarget({ skillIndex, oppLogs });
          return;
        }

        // ì¼ë°˜ ìŠ¤í‚¬
        let targetUid = user.uid;
        if (skillId.startsWith('opp-')) targetUid = oppUid;

        const targetPlayer = roomData.game.players[targetUid];
        if (!targetPlayer) return;

        const beforeVal = targetPlayer.effectiveCard ?? targetPlayer.selectedCard;
        if (beforeVal === null) return;

        let storedRandom = undefined;
        if (skillId === 'random') storedRandom = Math.floor(Math.random() * 11);

        const afterVal = applySkillValue(beforeVal, skillId, storedRandom);

        addEffect(skillId, targetUid);

        const updates = {};
        updates[`${basePath}/players/${targetUid}/effectiveCard`] = afterVal;

        const newSkills = [...myGame.skills];
        newSkills.splice(skillIndex, 1);
        updates[`${basePath}/players/${user.uid}/skills`] = newSkills;

        const logEntry = {
          id: Date.now(),
          byUid: user.uid,
          byName: roomData.players[user.uid].name,
          skillId,
          targetUid,
          beforeVal,
          afterVal,
          storedRandom,
          nullified: false
        };
        updates[`${basePath}/skillLog`] = [...(roomData.game.skillLog || []), logEntry];

        await db.ref().update(updates);
      };

      // ë¬´ë ¥í™” ì‹¤í–‰
      const executeNullify = async (targetLog) => {
        if (!nullifyTarget) return;
        const { skillIndex } = nullifyTarget;
        const myGame = roomData.game.players[user.uid];
        const basePath = `rooms/${roomId}/game`;

        addEffect('nullify', targetLog.targetUid);

        // íš¨ê³¼ ë˜ëŒë¦¬ê¸°
        const targetPlayer = roomData.game.players[targetLog.targetUid];
        const updates = {};
        updates[`${basePath}/players/${targetLog.targetUid}/effectiveCard`] = targetLog.beforeVal;

        // ë¡œê·¸ ì—…ë°ì´íŠ¸ (nullified í‘œì‹œ)
        const newLog = (roomData.game.skillLog || []).map(log =>
          log.id === targetLog.id ? { ...log, nullified: true } : log
        );
        newLog.push({
          id: Date.now(),
          byUid: user.uid,
          byName: roomData.players[user.uid].name,
          skillId: 'nullify',
          targetLogId: targetLog.id,
          desc: `${roomData.players[user.uid].name}ì´(ê°€) ${targetLog.byName}ì˜ ${SKILL_DEFS[targetLog.skillId]?.name}ì„(ë¥¼) ë¬´ë ¥í™”í–ˆìŠµë‹ˆë‹¤.`
        });
        updates[`${basePath}/skillLog`] = newLog;

        // ìŠ¤í‚¬ ì†Œë¹„
        const newSkills = [...myGame.skills];
        newSkills.splice(skillIndex, 1);
        updates[`${basePath}/players/${user.uid}/skills`] = newSkills;

        await db.ref().update(updates);
        setNullifyTarget(null);
      };

      // ë‹¤ìŒ í„´ ì¤€ë¹„ ì™„ë£Œ
      const setReady = async () => {
        await db.ref(`rooms/${roomId}/game/players/${user.uid}/ready`).set(true);
      };

      // í˜¸ìŠ¤íŠ¸: ì–‘ì¸¡ ì¤€ë¹„ â†’ ë‹¤ìŒ í„´
      useEffect(() => {
        if (!roomData?.game || !roomData?.host) return;
        if (roomData.host.uid !== user.uid) return;
        if (roomData.game.phase !== 'result') return;

        const entries = Object.entries(roomData.game.players || {});
        const allReady = entries.every(([uid, p]) => p.ready);
        if (!allReady) return;

        nextTurn();
      }, [roomData]);

      // ê²°ê³¼ í™•ì •
      const resolveRound = async () => {
        if (!roomData?.game) return;
        const g = roomData.game;
        if (g.phase !== 'skill') return;

        const entries = Object.entries(g.players || {});
        if (entries.length < 2) return;

        const basePath = `rooms/${roomId}/game`;
        const [uidA, pA] = entries[0];
        const [uidB, pB] = entries[1];

        const effA = pA.effectiveCard ?? pA.selectedCard;
        const effB = pB.effectiveCard ?? pB.selectedCard;
        if (effA === null || effB === null) return;

        const winnerUid = getWinnerUid(uidA, effA, uidB, effB);
        const updates = {};

        // ì ìˆ˜
        if (winnerUid) {
          updates[`${basePath}/players/${winnerUid}/score`] = (g.players[winnerUid].score || 0) + 1;
        }

        // ì‚¬ìš©í•œ ì¹´ë“œ ì œê±°
        updates[`${basePath}/players/${uidA}/hand`] = (pA.hand || []).filter(c => c !== pA.selectedCard);
        updates[`${basePath}/players/${uidB}/hand`] = (pB.hand || []).filter(c => c !== pB.selectedCard);

        // ìŠ¤í‚¬ ì§€ê¸‰
        const giveSkill = (uid, count) => {
          const cur = Array.isArray(g.players[uid].skills) ? [...g.players[uid].skills] : [];
          for (let i = 0; i < count; i++) cur.push(randomSkillId());
          updates[`${basePath}/players/${uid}/skills`] = cur;
        };

        const isTenVsZero = (effA === 10 && effB === 0) || (effA === 0 && effB === 10);
        const diff = Math.abs(effA - effB);

        if (winnerUid) {
          if (isTenVsZero) giveSkill(winnerUid, 2);
          else if (diff === 1) giveSkill(winnerUid, 1);
        } else {
          giveSkill(uidA, 1);
          giveSkill(uidB, 1);
        }

        // ê²°ê³¼ ì €ì¥
        updates[`${basePath}/lastResult`] = {
          [uidA]: { selected: pA.selectedCard, effective: effA },
          [uidB]: { selected: pB.selectedCard, effective: effB },
          winnerUid,
          turn: g.currentTurn
        };
        updates[`${basePath}/phase`] = 'result';
        updates[`${basePath}/players/${uidA}/ready`] = false;
        updates[`${basePath}/players/${uidB}/ready`] = false;

        await db.ref().update(updates);
      };

      // ë‹¤ìŒ í„´/ë¼ìš´ë“œ
      const nextTurn = async () => {
        if (!roomData?.game) return;
        const g = roomData.game;
        const basePath = `rooms/${roomId}/game`;
        const entries = Object.entries(g.players || {});
        const [uidA, pA] = entries[0];
        const [uidB, pB] = entries[1];

        const updates = {};

        // ì†íŒ¨ê°€ ë¹„ì—ˆìœ¼ë©´ ë¼ìš´ë“œ ì¢…ë£Œ
        const handsEmpty = (pA.hand?.length || 0) === 0 || (pB.hand?.length || 0) === 0;

        if (handsEmpty) {
          if (g.currentRound >= g.maxRounds) {
            updates[`${basePath}/phase`] = 'finished';
          } else {
            // ë‹¤ìŒ ë¼ìš´ë“œ
            updates[`${basePath}/currentRound`] = g.currentRound + 1;
            updates[`${basePath}/currentTurn`] = 1;
            updates[`${basePath}/phase`] = 'select';
            updates[`${basePath}/skillLog`] = [];
            // ì†íŒ¨ ë¦¬í•„
            [uidA, uidB].forEach(uid => {
              updates[`${basePath}/players/${uid}/hand`] = [0,1,2,3,4,5,6,7,8,9,10];
              updates[`${basePath}/players/${uid}/selectedCard`] = null;
              updates[`${basePath}/players/${uid}/effectiveCard`] = null;
              updates[`${basePath}/players/${uid}/originalCard`] = null;
            });
          }
        } else {
          updates[`${basePath}/currentTurn`] = g.currentTurn + 1;
          updates[`${basePath}/phase`] = 'select';
          updates[`${basePath}/skillLog`] = [];
          [uidA, uidB].forEach(uid => {
            updates[`${basePath}/players/${uid}/selectedCard`] = null;
            updates[`${basePath}/players/${uid}/effectiveCard`] = null;
            updates[`${basePath}/players/${uid}/originalCard`] = null;
          });
        }

        await db.ref().update(updates);
      };

      // ë‚˜ê°€ê¸°
      const handleExitGame = async () => {
        if (roomId && roomData) {
          const isHost = roomData.host?.uid === user.uid;
          if (isHost) await db.ref(`rooms/${roomId}`).remove();
          else await db.ref(`rooms/${roomId}/players/${user.uid}`).remove();
        }
        onExitRef.current();
      };

      // ë¡œë”©
      if (!roomData?.game) {
        return <div className="min-h-screen flex items-center justify-center text-amber-200">ê²Œì„ ì¤€ë¹„ ì¤‘...</div>;
      }

      const game = roomData.game;
      const isHost = roomData.host?.uid === user.uid;
      const myGame = game.players?.[user.uid];
      const oppUid = Object.keys(game.players).find(uid => uid !== user.uid);
      const oppGame = oppUid ? game.players[oppUid] : null;
      const myInfo = roomData.players?.[user.uid];
      const oppInfo = oppUid ? roomData.players?.[oppUid] : null;

      const phase = game.phase;
      const last = game.lastResult;

      // ìƒíƒœ í…ìŠ¤íŠ¸
      let statusText = '';
      let statusColor = 'text-amber-200';
      if (phase === 'select') {
        statusText = !myGame?.selectedCard ? 'ğŸƒ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”' : 'â³ ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...';
      } else if (phase === 'skill') {
        statusText = `âš¡ ìŠ¤í‚¬ ì‚¬ìš© ì¤‘... (${timer}ì´ˆ)`;
        statusColor = timer <= 3 ? 'text-red-400' : 'text-yellow-400';
      } else if (phase === 'result' && last) {
        if (!last.winnerUid) { statusText = 'ğŸ¤ ë¬´ìŠ¹ë¶€!'; statusColor = 'text-yellow-400'; }
        else if (last.winnerUid === user.uid) { statusText = 'ğŸ‰ ìŠ¹ë¦¬!'; statusColor = 'text-emerald-400'; }
        else { statusText = 'ğŸ˜¢ íŒ¨ë°°...'; statusColor = 'text-red-400'; }
      } else if (phase === 'finished') {
        const myScore = myGame?.score || 0;
        const oppScore = oppGame?.score || 0;
        if (myScore > oppScore) { statusText = 'ğŸ† ìµœì¢… ìŠ¹ë¦¬!'; statusColor = 'text-yellow-400'; }
        else if (myScore < oppScore) { statusText = 'ğŸ’” ìµœì¢… íŒ¨ë°°...'; statusColor = 'text-red-400'; }
        else { statusText = 'ğŸ¤ ë¬´ìŠ¹ë¶€!'; statusColor = 'text-yellow-400'; }
      }

      // í‘œì‹œí•  ì¹´ë“œ ê°’ (resultì—ì„œë„ ìœ ì§€)
      const displayMyCard = phase === 'result' || phase === 'finished'
        ? (last?.[user.uid]?.effective ?? myGame?.effectiveCard ?? myGame?.selectedCard)
        : (myGame?.effectiveCard ?? myGame?.selectedCard);
      const displayOppCard = phase === 'result' || phase === 'finished'
        ? (last?.[oppUid]?.effective ?? oppGame?.effectiveCard ?? oppGame?.selectedCard)
        : (phase === 'skill' ? (oppGame?.effectiveCard ?? oppGame?.selectedCard) : null);

      return (
        <div className="min-h-screen flex p-2 lg:p-4 gap-2 lg:gap-4 animate-fade-in">
          {/* ë©”ì¸ ê²Œì„ ë³´ë“œ */}
          <div className="flex-1 flex flex-col">
            <div className="wood-border rounded-2xl p-1 flex-1 flex flex-col">
              <div className="poker-table rounded-xl p-4 lg:p-6 flex-1 flex flex-col relative overflow-hidden">

                {/* ì´í™íŠ¸ ë ˆì´ì–´ */}
                {effects.map(eff => (
                  <div key={eff.id} className="skill-effect" style={{
                    left: eff.targetUid === user.uid ? '30%' : '70%',
                    top: '40%',
                    transform: 'translate(-50%, -50%)'
                  }}>
                    {eff.type === 'self-plus' || eff.type === 'opp-plus' ? <span className="effect-plus">+1</span> : null}
                    {eff.type === 'self-minus' || eff.type === 'opp-minus' ? <span className="effect-minus">-1</span> : null}
                    {eff.type === 'double' ? <span className="effect-double">Ã—2</span> : null}
                    {eff.type === 'random' ? <span className="effect-random">ğŸ²</span> : null}
                    {eff.type === 'retrieve' ? <span className="effect-retrieve">â†©</span> : null}
                    {eff.type === 'nullify' ? <span className="effect-nullify">âœ•</span> : null}
                  </div>
                ))}

                {/* ìƒë‹¨: ìƒëŒ€ ì •ë³´ */}
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-full bg-red-900/50 border-2 border-red-700 flex items-center justify-center text-xl font-bold text-red-300">
                      {oppInfo?.name?.[0] ?? '?'}
                    </div>
                    <div>
                      <p className="font-bold text-red-300">{oppInfo?.name ?? 'ìƒëŒ€'}</p>
                      <p className="text-xs text-red-300/60">ì ìˆ˜: {oppGame?.score ?? 0}</p>
                    </div>
                  </div>
                  <div className="text-center bg-black/30 px-4 py-2 rounded-lg">
                    <p className="text-xs text-amber-200/60">ROUND {game.currentRound}/{game.maxRounds}</p>
                    <p className="text-lg font-bold text-amber-200">TURN {game.currentTurn}/11</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <div className="text-right">
                      <p className="font-bold text-blue-300">{myInfo?.name}</p>
                      <p className="text-xs text-blue-300/60">ì ìˆ˜: {myGame?.score ?? 0}</p>
                    </div>
                    <div className="w-12 h-12 rounded-full bg-blue-900/50 border-2 border-blue-700 flex items-center justify-center text-xl font-bold text-blue-300">
                      {myInfo?.name?.[0]}
                    </div>
                  </div>
                </div>

                {/* íƒ€ì´ë¨¸ ë°” */}
                {phase === 'skill' && (
                  <div className="w-full bg-black/30 rounded-full h-2 mb-4 overflow-hidden">
                    <div className="timer-bar" style={{ width: `${(timer / 10) * 100}%` }}></div>
                  </div>
                )}

                {/* ìƒíƒœ ë©”ì‹œì§€ */}
                <div className="text-center py-2">
                  <p className={`text-2xl font-black ${statusColor}`}>{statusText}</p>
                </div>

                {/* ì¹´ë“œ ì˜ì—­ */}
                <div className="flex-1 flex items-center justify-center gap-8 lg:gap-16 py-4">
                  {/* ìƒëŒ€ ì¹´ë“œ */}
                  <div className="flex flex-col items-center">
                    <p className="text-sm text-red-300/60 mb-2">ìƒëŒ€ ì¹´ë“œ</p>
                    <div className={`poker-card w-20 h-28 lg:w-24 lg:h-32 flex items-center justify-center text-4xl lg:text-5xl font-black ${
                      displayOppCard !== null ? 'text-slate-900' : 'card-back'
                    } ${phase === 'result' && last?.winnerUid === oppUid ? 'animate-bounce-in' : ''}`}>
                      {displayOppCard !== null ? displayOppCard : ''}
                    </div>
                  </div>

                  <div className="text-4xl font-black text-amber-900/30">VS</div>

                  {/* ë‚´ ì¹´ë“œ */}
                  <div className="flex flex-col items-center">
                    <p className="text-sm text-blue-300/60 mb-2">ë‚´ ì¹´ë“œ</p>
                    <div className={`poker-card w-20 h-28 lg:w-24 lg:h-32 flex items-center justify-center text-4xl lg:text-5xl font-black text-blue-900 ${
                      phase === 'result' && last?.winnerUid === user.uid ? 'animate-bounce-in' : ''
                    }`}>
                      {displayMyCard !== null ? displayMyCard : '-'}
                    </div>
                  </div>
                </div>

                {/* ë‚´ ìŠ¤í‚¬ */}
                <div className="mb-4">
                  <p className="text-xs text-amber-200/60 mb-2">ë‚´ ìŠ¤í‚¬ ({(myGame?.skills || []).length})</p>
                  <div className="flex flex-wrap gap-2">
                    {(myGame?.skills || []).length === 0 ? (
                      <span className="text-amber-200/40 text-sm">ìŠ¤í‚¬ ì—†ìŒ</span>
                    ) : (myGame?.skills || []).map((skillId, idx) => {
                      const def = SKILL_DEFS[skillId];
                      return (
                        <button
                          key={idx}
                          disabled={phase !== 'skill' || timer <= 0}
                          onClick={() => useSkill(skillId, idx)}
                          className={`skill-btn px-3 py-2 rounded-lg text-sm font-bold text-white ${def?.color || 'bg-gray-600'} disabled:opacity-40 disabled:cursor-not-allowed`}
                          title={def?.desc}
                        >
                          {def?.icon} {def?.name}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* ë‚´ ì†íŒ¨ */}
                <div>
                  <p className="text-xs text-amber-200/60 mb-2">ë‚´ ì†íŒ¨ ({(myGame?.hand || []).length}ì¥)</p>
                  <div className="flex flex-wrap gap-1 justify-center">
                    {(myGame?.hand || []).map(card => (
                      <button
                        key={card}
                        disabled={phase !== 'select'}
                        onClick={() => selectCard(card)}
                        className={`poker-card w-12 h-16 lg:w-14 lg:h-20 flex items-center justify-center text-lg lg:text-xl font-bold text-slate-900 transition-all ${
                          myGame?.selectedCard === card ? 'selected' : ''
                        } ${phase !== 'select' ? 'opacity-50 cursor-not-allowed' : 'hover:transform hover:-translate-y-1 cursor-pointer'}`}
                      >
                        {card}
                      </button>
                    ))}
                  </div>
                </div>

                {/* í•˜ë‹¨ ë²„íŠ¼ */}
                <div className="flex justify-between items-center mt-4 pt-4 border-t border-amber-900/30">
                  <button onClick={handleExitGame} className="text-sm text-amber-200/50 hover:text-amber-200">
                    ğŸšª ë‚˜ê°€ê¸°
                  </button>

                  {phase === 'skill' && isHost && (
                    <button onClick={resolveRound} className="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-white">
                      âš¡ ê²°ê³¼ í™•ì •
                    </button>
                  )}

                  {phase === 'result' && (
                    <button
                      onClick={setReady}
                      disabled={myGame?.ready}
                      className={`px-6 py-2 rounded-lg font-bold text-white transition-all ${
                        myGame?.ready ? 'bg-gray-600 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-500'
                      }`}
                    >
                      {myGame?.ready ? 'âœ“ ì¤€ë¹„ ì™„ë£Œ' : 'â¡ ë‹¤ìŒ í„´'}
                    </button>
                  )}

                  {phase === 'finished' && (
                    <button onClick={handleExitGame} className="px-6 py-2 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-white">
                      ë¡œë¹„ë¡œ
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* ìŠ¤í‚¬ ë¡œê·¸ ì‚¬ì´ë“œë°” */}
          <div className="w-64 lg:w-80 hidden md:block">
            <div className="wood-border rounded-2xl p-1 h-full">
              <div className="poker-table rounded-xl p-4 h-full flex flex-col">
                <h3 className="text-amber-200 font-bold mb-3 text-center">ğŸ“œ ìŠ¤í‚¬ ë¡œê·¸</h3>
                <div className="flex-1 overflow-y-auto space-y-2">
                  {(game.skillLog || []).length === 0 ? (
                    <p className="text-amber-200/40 text-sm text-center">ì•„ì§ ì‚¬ìš©ëœ ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  ) : (game.skillLog || []).slice().reverse().map((log, idx) => {
                    const def = SKILL_DEFS[log.skillId];
                    return (
                      <div key={idx} className={`p-2 rounded-lg text-xs ${log.nullified ? 'bg-black/30 opacity-50 line-through' : 'bg-black/20'} animate-slide-up`}>
                        {log.desc ? (
                          <p className="text-amber-200/80">{log.desc}</p>
                        ) : (
                          <>
                            <p className="text-amber-200/80">
                              <span className={log.byUid === user.uid ? 'text-blue-400' : 'text-red-400'}>{log.byName}</span>
                              {' â†’ '}{def?.name}
                            </p>
                            {log.beforeVal !== undefined && (
                              <p className="text-amber-200/60 mt-1">
                                {log.beforeVal} â†’ <span className="text-yellow-400 font-bold">{log.afterVal}</span>
                                {log.nullified && <span className="text-red-400 ml-2">(ë¬´ë ¥í™”ë¨)</span>}
                              </p>
                            )}
                          </>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          {/* ë¬´ë ¥í™” íƒ€ê²Ÿ ì„ íƒ ëª¨ë‹¬ */}
          {nullifyTarget && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 animate-fade-in">
              <div className="wood-border rounded-2xl p-1 max-w-md w-full mx-4">
                <div className="poker-table rounded-xl p-6">
                  <h3 className="text-xl font-bold text-amber-200 mb-4 text-center">ë¬´ë ¥í™”í•  ìŠ¤í‚¬ ì„ íƒ</h3>
                  <div className="space-y-2 max-h-60 overflow-y-auto">
                    {nullifyTarget.oppLogs.map((log, idx) => {
                      const def = SKILL_DEFS[log.skillId];
                      return (
                        <button
                          key={idx}
                          onClick={() => executeNullify(log)}
                          className="w-full p-3 bg-black/30 hover:bg-red-900/50 rounded-lg text-left transition-colors"
                        >
                          <p className="text-amber-200 font-bold">{def?.name}</p>
                          <p className="text-xs text-amber-200/60">{log.beforeVal} â†’ {log.afterVal}</p>
                        </button>
                      );
                    })}
                  </div>
                  <button
                    onClick={() => setNullifyTarget(null)}
                    className="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white"
                  >
                    ì·¨ì†Œ
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>