<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Zero Point: PVP</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background-color: #0f172a;
      color: white;
      -webkit-tap-highlight-color: transparent;
    }
    .animate-fade-in { animation: fadeIn 0.35s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .glass {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-40px) scale(1.5); }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px rgba(234, 179, 8, 0.5); }
      50% { box-shadow: 0 0 20px rgba(234, 179, 8, 0.8); }
    }
    .animate-pulse-glow { animation: pulse-glow 1.5s infinite; }
    .effect-text {
      position: absolute;
      font-size: 1.5rem;
      font-weight: bold;
      pointer-events: none;
      animation: floatUp 0.8s forwards;
      z-index: 100;
    }
    
    .timer-bar {
      height: 4px;
      background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
      transition: width 0.1s linear;
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyAy9neN8_-8HWZNcQluP6jGbzNQMICWc6s",
      authDomain: "zero-pvp.firebaseapp.com",
      projectId: "zero-pvp",
      storageBucket: "zero-pvp.firebasestorage.app",
      messagingSenderId: "634718710928",
      appId: "1:634718710928:web:b5339abd5d443c1ca83c15",
      databaseURL: "https://zero-pvp-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const getWinnerUid = (uidA, cardA, uidB, cardB) => {
      if (cardA === cardB) return null;
      if (cardA === 10 && cardB === 0) return uidA;
      if (cardB === 10 && cardA === 0) return uidB;
      return cardA < cardB ? uidA : uidB;
    };

    const SKILL_DEFS = {
      'self-plus':  { id: 'self-plus',  name: 'ë³¸ì¸+1',  color: 'bg-green-600', desc: 'ë‚´ ì¹´ë“œ +1' },
      'self-minus': { id: 'self-minus', name: 'ë³¸ì¸-1',  color: 'bg-green-500', desc: 'ë‚´ ì¹´ë“œ -1' },
      'opp-plus':   { id: 'opp-plus',   name: 'ìƒëŒ€+1',  color: 'bg-red-600', desc: 'ìƒëŒ€ ì¹´ë“œ +1' },
      'opp-minus':  { id: 'opp-minus',  name: 'ìƒëŒ€-1',  color: 'bg-red-500', desc: 'ìƒëŒ€ ì¹´ë“œ -1' },
      'double':     { id: 'double',     name: '2ë°°',     color: 'bg-yellow-600', desc: 'ë‚´ ì¹´ë“œ x2' },
      'random':     { id: 'random',     name: 'ëœë¤',    color: 'bg-purple-600', desc: '0~10 ëœë¤' },
      'retrieve':   { id: 'retrieve',   name: 'íšŒìˆ˜',    color: 'bg-blue-600', desc: 'í„´ ë¦¬ì…‹' },
      'nullify':    { id: 'nullify',    name: 'ë¬´ë ¥í™”',  color: 'bg-gray-600', desc: 'ìŠ¤í‚¬ ì·¨ì†Œ' }
    };
    const SKILL_IDS = Object.keys(SKILL_DEFS);
    const randomSkillId = () => SKILL_IDS[Math.floor(Math.random() * SKILL_IDS.length)];

    const applySkillValue = (val, skillId, storedRandom) => {
      if (val === null || val === undefined) return val;
      let v = Number(val);
      if (isNaN(v)) return val;
      switch (skillId) {
        case 'self-plus': case 'opp-plus': return v + 1 > 10 ? 0 : v + 1;
        case 'self-minus': case 'opp-minus': return v - 1 < 0 ? 10 : v - 1;
        case 'double': { let d = v * 2; return d > 10 ? d % 10 : d; }
        case 'random': return storedRandom !== undefined ? storedRandom : v;
        default: return v;
      }
    };

    // ==================== App ====================
    const App = () => {
      const [user, setUser] = useState(null);
      const [screen, setScreen] = useState('menu');
      const [playerName, setPlayerName] = useState('');
      const [currentRoomId, setCurrentRoomId] = useState(null);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          if (u) setUser(u);
          else auth.signInAnonymously();
        });
        return () => unsub();
      }, []);

      const handleExitToLobby = useCallback(() => {
        setScreen('lobby');
        setCurrentRoomId(null);
      }, []);

      if (!user) {
        return (
          <div className="min-h-screen flex items-center justify-center text-slate-400">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              ì„œë²„ ì—°ê²° ì¤‘...
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-900 text-white">
          {screen === 'menu' && <MenuScreen onStart={(name) => { setPlayerName(name); setScreen('lobby'); }} />}
          {screen === 'lobby' && <LobbyScreen user={user} playerName={playerName} onBack={() => setScreen('menu')} onJoinRoom={(id) => { setCurrentRoomId(id); setScreen('room'); }} />}
          {screen === 'room' && <WaitingRoom user={user} playerName={playerName} roomId={currentRoomId} onGameStart={() => setScreen('game')} onLeave={handleExitToLobby} />}
          {screen === 'game' && <GameScreen user={user} roomId={currentRoomId} onExit={handleExitToLobby} />}
        </div>
      );
    };

    // ==================== Menu ====================
    const MenuScreen = ({ onStart }) => {
      const [name, setName] = useState('');
      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 animate-fade-in">
          <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 mb-3">ZERO</h1>
          <p className="text-slate-400 mb-10 text-xs tracking-[0.35em] uppercase">Point PvP</p>
          <div className="w-full max-w-xs glass p-6 rounded-2xl flex flex-col gap-4">
            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="ë‹‰ë„¤ì„ (2~8ì)" maxLength={8} className="w-full px-4 py-3 bg-slate-800 rounded-xl text-center text-white outline-none border border-slate-700 focus:border-blue-500" />
            <button onClick={() => name.trim().length >= 2 && onStart(name.trim())} disabled={name.trim().length < 2} className="w-full py-3 bg-blue-600 rounded-xl font-bold disabled:opacity-50 active:scale-95 transition-transform">ENTER LOBBY</button>
          </div>
        </div>
      );
    };

    // ==================== Lobby ====================
    const LobbyScreen = ({ user, playerName, onBack, onJoinRoom }) => {
      const [rooms, setRooms] = useState([]);

      useEffect(() => {
        const roomsRef = db.ref('rooms');
        const listener = roomsRef.on('value', (snapshot) => {
          const data = snapshot.val();
          const list = [];
          if (data) {
            Object.entries(data).forEach(([roomId, room]) => {
              if (!room.players || Object.keys(room.players).length === 0) return;
              if (!room.host || room.status !== 'waiting') return;
              list.push({ id: roomId, ...room });
            });
          }
          list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
          setRooms(list);
        });
        return () => roomsRef.off('value', listener);
      }, []);

      const createRoom = async () => {
        const roomRef = db.ref('rooms').push();
        await roomRef.set({
          status: 'waiting',
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          host: { uid: user.uid, name: playerName },
          settings: { maxRounds: 3 }
        });
        await roomRef.child(`players/${user.uid}`).set({ name: playerName, ready: false });
        roomRef.child(`players/${user.uid}`).onDisconnect().remove();
        onJoinRoom(roomRef.key);
      };

      const joinRoom = async (roomId) => {
        const roomRef = db.ref(`rooms/${roomId}`);
        const snap = await roomRef.get();
        if (!snap.exists()) return alert("ë°©ì´ ì—†ìŠµë‹ˆë‹¤.");
        const room = snap.val();
        if (Object.keys(room.players || {}).length >= 2) return alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
        await roomRef.child(`players/${user.uid}`).set({ name: playerName, ready: false });
        roomRef.child(`players/${user.uid}`).onDisconnect().remove();
        onJoinRoom(roomId);
      };

      return (
        <div className="min-h-screen p-4 max-w-2xl mx-auto animate-fade-in">
          <header className="flex justify-between items-center py-6">
            <button onClick={onBack} className="text-slate-400 hover:text-white">â† EXIT</button>
            <h2 className="font-bold text-xl text-slate-100">LOBBY</h2>
            <div className="w-10"></div>
          </header>
          <div className="glass p-6 rounded-2xl mb-6 flex justify-between items-center">
            <div><p className="text-xs text-slate-400">PLAYER</p><p className="font-bold text-blue-400 text-lg">{playerName}</p></div>
            <button onClick={createRoom} className="bg-blue-600 px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform">+ CREATE ROOM</button>
          </div>
          <div className="space-y-3">
            {rooms.length === 0 ? <div className="text-center py-10 text-slate-500">ëŒ€ê¸° ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div> : rooms.map(room => (
              <div key={room.id} className="bg-slate-800/90 p-5 rounded-xl flex justify-between items-center border border-slate-700">
                <div><div className="font-bold text-lg text-white">{room.host.name}</div><div className="text-xs text-slate-500">#{room.id.slice(-4)} Â· {room.settings?.maxRounds || 3}ë¼ìš´ë“œ</div></div>
                <button onClick={() => joinRoom(room.id)} className="bg-slate-700 hover:bg-green-600 px-6 py-2 rounded-lg font-bold text-white transition-colors">JOIN</button>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // ==================== Waiting Room ====================
    const WaitingRoom = ({ user, playerName, roomId, onLeave, onGameStart }) => {
      const [roomData, setRoomData] = useState(null);
      const [selectedRounds, setSelectedRounds] = useState(3);

      useEffect(() => {
        const roomRef = db.ref(`rooms/${roomId}`);
        const listener = roomRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (!data) { alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); onLeave(); return; }
          setRoomData(data);
          if (data.settings?.maxRounds) setSelectedRounds(data.settings.maxRounds);
          if (data.status === 'playing') onGameStart();
        });
        return () => roomRef.off('value', listener);
      }, [roomId, onLeave, onGameStart]);

      const handleLeave = async () => {
        if (!roomData) { onLeave(); return; }
        const isHost = roomData.host?.uid === user.uid;
        if (isHost) await db.ref(`rooms/${roomId}`).remove();
        else await db.ref(`rooms/${roomId}/players/${user.uid}`).remove();
        onLeave();
      };

      const toggleReady = async () => {
        if (!roomData?.players?.[user.uid]) return;
        await db.ref(`rooms/${roomId}/players/${user.uid}/ready`).set(!roomData.players[user.uid].ready);
      };

      const updateRounds = async (rounds) => {
        setSelectedRounds(rounds);
        await db.ref(`rooms/${roomId}/settings/maxRounds`).set(rounds);
      };

      const startGame = async () => {
        await db.ref(`rooms/${roomId}`).update({ status: 'playing', startedAt: firebase.database.ServerValue.TIMESTAMP });
      };

      if (!roomData?.players?.[user.uid]) return <div className="min-h-screen flex items-center justify-center text-slate-400">ë¡œë”© ì¤‘...</div>;

      const me = roomData.players[user.uid];
      const isHost = roomData.host?.uid === user.uid;
      const players = Object.entries(roomData.players);
      const opponentEntry = players.find(([uid]) => uid !== user.uid);
      const opponent = opponentEntry ? opponentEntry[1] : null;
      const canStart = opponent && me.ready && opponent.ready;

      return (
        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in">
          <div className="w-full max-w-lg glass rounded-3xl p-8 shadow-2xl">
            <h2 className="text-2xl font-bold text-white text-center mb-2">WAITING ROOM</h2>
            <p className="text-center text-slate-500 text-xs mb-6">Room #{roomId.slice(-4)} {isHost && <span className="ml-2 px-2 py-0.5 bg-yellow-900 text-yellow-200 rounded text-xs">HOST</span>}</p>
            
            {isHost && (
              <div className="mb-6 text-center">
                <p className="text-slate-400 text-sm mb-2">ë¼ìš´ë“œ ìˆ˜</p>
                <div className="flex justify-center gap-2">
                  {[3, 4, 5].map(n => (
                    <button key={n} onClick={() => updateRounds(n)} className={`w-12 h-12 rounded-lg font-bold text-lg transition-all ${selectedRounds === n ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}>{n}</button>
                  ))}
                </div>
              </div>
            )}
            {!isHost && <p className="text-center text-slate-400 mb-6">{selectedRounds}ë¼ìš´ë“œ ê²Œì„</p>}

            <div className="flex justify-between items-center mb-8">
              <PlayerSlot player={me} isReady={me.ready} label="(ë‚˜)" />
              <span className="text-2xl font-black text-slate-700 italic">VS</span>
              {opponent ? <PlayerSlot player={opponent} isReady={opponent.ready} label="" /> : (
                <div className="flex flex-col items-center"><div className="w-20 h-20 rounded-full bg-slate-800 border-4 border-dashed border-slate-700 flex items-center justify-center animate-pulse text-2xl text-slate-600">?</div><span className="text-slate-500 text-sm mt-2">ëŒ€ê¸° ì¤‘...</span></div>
              )}
            </div>

            <div className="space-y-3">
              {isHost && <button onClick={startGame} disabled={!canStart} className={`w-full py-4 rounded-xl font-black text-lg transition-all ${canStart ? 'bg-green-600 hover:bg-green-500 text-white animate-pulse-glow' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>{canStart ? 'START GAME ğŸš€' : 'ëª¨ë‘ ì¤€ë¹„ í•„ìš”'}</button>}
              <button onClick={toggleReady} className={`w-full py-3 rounded-xl font-bold transition-all active:scale-95 ${me.ready ? 'bg-slate-700 text-slate-400' : 'bg-blue-600 text-white hover:bg-blue-500'}`}>{me.ready ? 'ì¤€ë¹„ ì·¨ì†Œ' : 'ì¤€ë¹„ ì™„ë£Œ!'}</button>
              <button onClick={handleLeave} className="w-full py-2 text-slate-500 hover:text-white text-sm">ë‚˜ê°€ê¸°</button>
            </div>
          </div>
        </div>
      );
    };

    const PlayerSlot = ({ player, isReady, label }) => (
      <div className="flex flex-col items-center">
        <div className={`w-20 h-20 rounded-full flex items-center justify-center text-2xl font-black border-4 transition-all ${isReady ? 'border-green-500 bg-green-900/30 text-green-400' : 'border-blue-500 bg-slate-800 text-white'}`}>{player.name[0]}</div>
        <span className="font-bold text-white mt-2">{player.name} {label}</span>
        <span className={`text-xs px-2 py-1 rounded mt-1 ${isReady ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'}`}>{isReady ? 'READY' : 'WAITING'}</span>
      </div>
    );

    // ==================== Game Screen ====================
    const GameScreen = ({ user, roomId, onExit }) => {
      const [roomData, setRoomData] = useState(null);
      const [isInitializing, setIsInitializing] = useState(false);
      const [timer, setTimer] = useState(10);
      const [effects, setEffects] = useState([]);
      const [nullifyMode, setNullifyMode] = useState(null);
      const onExitRef = useRef(onExit);
      const timerRef = useRef(null);
      const processingRef = useRef(false);

      useEffect(() => { onExitRef.current = onExit; }, [onExit]);

      // ì‹¤ì‹œê°„ êµ¬ë…
      useEffect(() => {
        const roomRef = db.ref(`rooms/${roomId}`);
        const listener = roomRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (!data) { alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); onExitRef.current(); return; }
          setRoomData(data);
        });
        return () => roomRef.off('value', listener);
      }, [roomId]);

      // í˜¸ìŠ¤íŠ¸: ê²Œì„ ì´ˆê¸°í™”
      useEffect(() => {
        if (!roomData?.host || !roomData?.players || roomData.game || isInitializing) return;
        if (roomData.host.uid !== user.uid) return;

        const initGame = async () => {
          setIsInitializing(true);
          const gamePlayers = {};
          Object.entries(roomData.players).forEach(([uid, p]) => {
            gamePlayers[uid] = {
              score: 0,
              hand: [0,1,2,3,4,5,6,7,8,9,10],
              selectedCard: null,
              effectiveCard: null,
              skills: [randomSkillId(), randomSkillId()],
              ready: false
            };
          });
          await db.ref(`rooms/${roomId}/game`).set({
            maxRounds: roomData.settings?.maxRounds || 3,
            currentRound: 1,
            currentTurn: 1,
            phase: 'select',
            lastResult: null,
            skillLog: [],
            skillRequests: null,
            players: gamePlayers
          });
          setIsInitializing(false);
        };
        initGame();
      }, [roomData, roomId, user.uid, isInitializing]);

      // í˜¸ìŠ¤íŠ¸: ë‘˜ ë‹¤ ì¹´ë“œ ì„ íƒ â†’ skill í˜ì´ì¦ˆ
      useEffect(() => {
        if (!roomData?.game || !roomData?.host || roomData.host.uid !== user.uid) return;
        if (roomData.game.phase !== 'select') return;
        const entries = Object.entries(roomData.game.players || {});
        if (entries.length < 2) return;
        const allSelected = entries.every(([uid, p]) => p.selectedCard !== null && p.selectedCard !== undefined);
        if (!allSelected) return;

        const basePath = `rooms/${roomId}/game`;
        const updates = {};
        entries.forEach(([uid, p]) => {
          updates[`${basePath}/players/${uid}/effectiveCard`] = p.selectedCard;
        });
        updates[`${basePath}/phase`] = 'skill';
        updates[`${basePath}/skillLog`] = [];
        updates[`${basePath}/skillRequests`] = null;
        db.ref().update(updates);
      }, [roomData, roomId, user.uid]);

      // í˜¸ìŠ¤íŠ¸: skillRequests ì²˜ë¦¬
      useEffect(() => {
        if (!roomData?.game || !roomData?.host || roomData.host.uid !== user.uid) return;
        if (roomData.game.phase !== 'skill') return;
        if (!roomData.game.skillRequests) return;
        if (processingRef.current) return;

        const requests = Object.entries(roomData.game.skillRequests);
        if (requests.length === 0) return;

        processingRef.current = true;

        const processRequests = async () => {
          const basePath = `rooms/${roomId}/game`;
          const g = roomData.game;
          const updates = {};
          let currentLog = [...(g.skillLog || [])];
          let localPlayers = JSON.parse(JSON.stringify(g.players));

          // ìš”ì²­ ì •ë ¬ (ì‹œê°„ìˆœ)
          requests.sort((a, b) => (a[1].createdAt || 0) - (b[1].createdAt || 0));

          for (const [reqId, req] of requests) {
            const { uid, skillId, skillIndex, targetLogId } = req;
            const player = localPlayers[uid];
            if (!player || !player.skills) continue;

            const actualIndex = player.skills.indexOf(skillId);
            if (actualIndex === -1) continue;

            const oppUid = Object.keys(localPlayers).find(x => x !== uid);
            const playerName = roomData.players[uid]?.name || 'Unknown';

            // íšŒìˆ˜
            if (skillId === 'retrieve') {
              Object.keys(localPlayers).forEach(u => {
                updates[`${basePath}/players/${u}/selectedCard`] = null;
                updates[`${basePath}/players/${u}/effectiveCard`] = null;
                localPlayers[u].selectedCard = null;
                localPlayers[u].effectiveCard = null;
              });
              updates[`${basePath}/phase`] = 'select';
              currentLog.push({ id: Date.now(), byUid: uid, byName: playerName, skillId, desc: `${playerName}ì´(ê°€) íšŒìˆ˜ - í„´ ë¦¬ì…‹` });
              player.skills.splice(actualIndex, 1);
              updates[`${basePath}/players/${uid}/skills`] = player.skills;
              break; // íšŒìˆ˜ í›„ ë‹¤ë¥¸ ìŠ¤í‚¬ ì²˜ë¦¬ ì¤‘ë‹¨
            }

            // ë¬´ë ¥í™”
            if (skillId === 'nullify' && targetLogId) {
              const targetLog = currentLog.find(l => l.id === targetLogId);
              if (targetLog && !targetLog.nullified && targetLog.beforeVal !== undefined) {
                updates[`${basePath}/players/${targetLog.targetUid}/effectiveCard`] = targetLog.beforeVal;
                localPlayers[targetLog.targetUid].effectiveCard = targetLog.beforeVal;
                targetLog.nullified = true;
                currentLog.push({ id: Date.now(), byUid: uid, byName: playerName, skillId: 'nullify', desc: `${playerName}ì´(ê°€) ${targetLog.byName}ì˜ ${SKILL_DEFS[targetLog.skillId]?.name}ì„(ë¥¼) ë¬´ë ¥í™”` });
                player.skills.splice(actualIndex, 1);
                updates[`${basePath}/players/${uid}/skills`] = player.skills;
              }
              continue;
            }

            // ì¼ë°˜ ìŠ¤í‚¬
            let targetUid = uid;
            if (skillId.startsWith('opp-')) targetUid = oppUid;
            const targetPlayer = localPlayers[targetUid];
            if (!targetPlayer) continue;

            const beforeVal = targetPlayer.effectiveCard ?? targetPlayer.selectedCard;
            if (beforeVal === null || beforeVal === undefined) continue;

            let storedRandom;
            if (skillId === 'random') storedRandom = Math.floor(Math.random() * 11);
            const afterVal = applySkillValue(beforeVal, skillId, storedRandom);

            updates[`${basePath}/players/${targetUid}/effectiveCard`] = afterVal;
            localPlayers[targetUid].effectiveCard = afterVal;

            currentLog.push({
              id: Date.now() + Math.random(),
              byUid: uid,
              byName: playerName,
              skillId,
              targetUid,
              beforeVal,
              afterVal,
              storedRandom,
              nullified: false
            });

            player.skills.splice(actualIndex, 1);
            updates[`${basePath}/players/${uid}/skills`] = [...player.skills];
          }

          updates[`${basePath}/skillLog`] = currentLog;
          updates[`${basePath}/skillRequests`] = null;

          await db.ref().update(updates);
          processingRef.current = false;
        };

        processRequests();
      }, [roomData, roomId, user.uid]);

      // ìŠ¤í‚¬ í˜ì´ì¦ˆ íƒ€ì´ë¨¸
      useEffect(() => {
        if (!roomData?.game || roomData.game.phase !== 'skill') {
          setTimer(10);
          if (timerRef.current) clearInterval(timerRef.current);
          return;
        }
        setTimer(10);
        timerRef.current = setInterval(() => {
          setTimer(prev => {
            if (prev <= 1) { clearInterval(timerRef.current); return 0; }
            return prev - 1;
          });
        }, 1000);
        return () => { if (timerRef.current) clearInterval(timerRef.current); };
      }, [roomData?.game?.phase, roomData?.game?.currentTurn]);

      // íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ìë™ ê²°ê³¼ í™•ì •
      useEffect(() => {
        if (timer === 0 && roomData?.game?.phase === 'skill' && roomData?.host?.uid === user.uid) {
          resolveRound();
        }
      }, [timer]);

      // í˜¸ìŠ¤íŠ¸: ì–‘ì¸¡ ì¤€ë¹„ ì™„ë£Œ â†’ ë‹¤ìŒ í„´
      useEffect(() => {
        if (!roomData?.game || !roomData?.host || roomData.host.uid !== user.uid) return;
        if (roomData.game.phase !== 'result') return;
        const entries = Object.entries(roomData.game.players || {});
        if (entries.length < 2) return;
        const allReady = entries.every(([uid, p]) => p.ready);
        if (allReady) nextTurn();
      }, [roomData]);

      // ì´í™íŠ¸ ì¶”ê°€
      const addEffect = (type) => {
        const id = Date.now();
        setEffects(prev => [...prev, { id, type }]);
        setTimeout(() => setEffects(prev => prev.filter(e => e.id !== id)), 800);
      };

      // ì¹´ë“œ ì„ íƒ
      const selectCard = async (card) => {
        if (!roomData?.game || roomData.game.phase !== 'select') return;
        const myGame = roomData.game.players?.[user.uid];
        if (!myGame?.hand?.includes(card)) return;
        await db.ref(`rooms/${roomId}/game/players/${user.uid}/selectedCard`).set(card);
      };

      // ìŠ¤í‚¬ ì‚¬ìš© ìš”ì²­
      const useSkill = async (skillId, skillIndex) => {
        if (!roomData?.game || roomData.game.phase !== 'skill' || timer <= 0) return;
        const myGame = roomData.game.players?.[user.uid];
        if (!myGame?.skills?.[skillIndex] || myGame.skills[skillIndex] !== skillId) return;

        // ë¬´ë ¥í™”ëŠ” íƒ€ê²Ÿ ì„ íƒ í•„ìš”
        if (skillId === 'nullify') {
          const oppUid = Object.keys(roomData.game.players).find(uid => uid !== user.uid);
          const oppLogs = (roomData.game.skillLog || []).filter(log => 
            log.byUid === oppUid && !log.nullified && log.skillId !== 'retrieve' && log.skillId !== 'nullify' && log.beforeVal !== undefined
          );
          if (oppLogs.length === 0) { alert('ë¬´ë ¥í™”í•  ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
          setNullifyMode({ skillIndex, oppLogs });
          return;
        }

        addEffect(skillId === 'retrieve' ? 'â†©' : skillId.includes('plus') ? '+1' : skillId.includes('minus') ? '-1' : skillId === 'double' ? 'x2' : '?');

        const reqRef = db.ref(`rooms/${roomId}/game/skillRequests`).push();
        await reqRef.set({
          uid: user.uid,
          skillId,
          skillIndex,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
      };

      // ë¬´ë ¥í™” ì‹¤í–‰
      const executeNullify = async (targetLog) => {
        if (!nullifyMode) return;
        addEffect('âœ•');
        const reqRef = db.ref(`rooms/${roomId}/game/skillRequests`).push();
        await reqRef.set({
          uid: user.uid,
          skillId: 'nullify',
          skillIndex: nullifyMode.skillIndex,
          targetLogId: targetLog.id,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        setNullifyMode(null);
      };

      // ë‹¤ìŒ í„´ ì¤€ë¹„
      const setReady = async () => {
        await db.ref(`rooms/${roomId}/game/players/${user.uid}/ready`).set(true);
      };

      // ê²°ê³¼ í™•ì • (í˜¸ìŠ¤íŠ¸ë§Œ)
      const resolveRound = async () => {
        if (!roomData?.game || roomData.game.phase !== 'skill') return;
        if (roomData.host?.uid !== user.uid) return;

        const g = roomData.game;
        const entries = Object.entries(g.players || {});
        if (entries.length < 2) return;

        const basePath = `rooms/${roomId}/game`;
        const [uidA, pA] = entries[0];
        const [uidB, pB] = entries[1];
        const effA = pA.effectiveCard ?? pA.selectedCard;
        const effB = pB.effectiveCard ?? pB.selectedCard;
        if (effA === null || effB === null) return;

        const winnerUid = getWinnerUid(uidA, effA, uidB, effB);
        const updates = {};

        if (winnerUid) updates[`${basePath}/players/${winnerUid}/score`] = (g.players[winnerUid].score || 0) + 1;

        // ì¹´ë“œ ì œê±°
        updates[`${basePath}/players/${uidA}/hand`] = (pA.hand || []).filter(c => c !== pA.selectedCard);
        updates[`${basePath}/players/${uidB}/hand`] = (pB.hand || []).filter(c => c !== pB.selectedCard);

        // ìŠ¤í‚¬ ì§€ê¸‰
        const giveSkill = (uid, count) => {
          const cur = [...(g.players[uid].skills || [])];
          for (let i = 0; i < count; i++) cur.push(randomSkillId());
          updates[`${basePath}/players/${uid}/skills`] = cur;
        };

        const isTenVsZero = (effA === 10 && effB === 0) || (effA === 0 && effB === 10);
        const diff = Math.abs(effA - effB);
        if (winnerUid) {
          if (isTenVsZero) giveSkill(winnerUid, 2);
          else if (diff === 1) giveSkill(winnerUid, 1);
        } else {
          giveSkill(uidA, 1);
          giveSkill(uidB, 1);
        }

        updates[`${basePath}/lastResult`] = { [uidA]: { selected: pA.selectedCard, effective: effA }, [uidB]: { selected: pB.selectedCard, effective: effB }, winnerUid, turn: g.currentTurn };
        updates[`${basePath}/phase`] = 'result';
        updates[`${basePath}/players/${uidA}/ready`] = false;
        updates[`${basePath}/players/${uidB}/ready`] = false;
        await db.ref().update(updates);
      };

      // ë‹¤ìŒ í„´ (í˜¸ìŠ¤íŠ¸ê°€ ì²˜ë¦¬)
      const nextTurn = async () => {
        if (!roomData?.game || roomData.host?.uid !== user.uid) return;
        const g = roomData.game;
        const basePath = `rooms/${roomId}/game`;
        const entries = Object.entries(g.players || {});
        if (entries.length < 2) return;
        const [uidA, pA] = entries[0];
        const [uidB, pB] = entries[1];
        const updates = {};

        const handsEmpty = (pA.hand?.length || 0) === 0 || (pB.hand?.length || 0) === 0;
        if (handsEmpty) {
          if (g.currentRound >= g.maxRounds) {
            updates[`${basePath}/phase`] = 'finished';
          } else {
            updates[`${basePath}/currentRound`] = g.currentRound + 1;
            updates[`${basePath}/currentTurn`] = 1;
            updates[`${basePath}/phase`] = 'select';
            updates[`${basePath}/skillLog`] = [];
            [uidA, uidB].forEach(uid => {
              updates[`${basePath}/players/${uid}/hand`] = [0,1,2,3,4,5,6,7,8,9,10];
              updates[`${basePath}/players/${uid}/selectedCard`] = null;
              updates[`${basePath}/players/${uid}/effectiveCard`] = null;
              updates[`${basePath}/players/${uid}/ready`] = false;
            });
          }
        } else {
          updates[`${basePath}/currentTurn`] = g.currentTurn + 1;
          updates[`${basePath}/phase`] = 'select';
          updates[`${basePath}/skillLog`] = [];
          [uidA, uidB].forEach(uid => {
            updates[`${basePath}/players/${uid}/selectedCard`] = null;
            updates[`${basePath}/players/${uid}/effectiveCard`] = null;
            updates[`${basePath}/players/${uid}/ready`] = false;
          });
        }
        await db.ref().update(updates);
      };

      // ë‚˜ê°€ê¸°
      const handleExitGame = async () => {
        if (roomId && roomData) {
          if (roomData.host?.uid === user.uid) await db.ref(`rooms/${roomId}`).remove();
          else await db.ref(`rooms/${roomId}/players/${user.uid}`).remove();
        }
        onExitRef.current();
      };

      if (!roomData?.game) return <div className="min-h-screen flex items-center justify-center text-slate-400">ê²Œì„ ì¤€ë¹„ ì¤‘...</div>;

      const game = roomData.game;
      const isHost = roomData.host?.uid === user.uid;
      const myGame = game.players?.[user.uid];
      const oppUid = Object.keys(game.players).find(uid => uid !== user.uid);
      const oppGame = oppUid ? game.players[oppUid] : null;
      const myInfo = roomData.players?.[user.uid];
      const oppInfo = oppUid ? roomData.players?.[oppUid] : null;
      const phase = game.phase;
      const last = game.lastResult;

      let statusText = '', statusColor = 'text-white';
      if (phase === 'select') statusText = !myGame?.selectedCard ? 'ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”' : 'ìƒëŒ€ ëŒ€ê¸° ì¤‘...';
      else if (phase === 'skill') { statusText = `ìŠ¤í‚¬ ì‚¬ìš© (${timer}ì´ˆ)`; statusColor = timer <= 3 ? 'text-red-400' : 'text-yellow-400'; }
      else if (phase === 'result' && last) {
        if (!last.winnerUid) { statusText = 'ë¬´ìŠ¹ë¶€!'; statusColor = 'text-yellow-400'; }
        else if (last.winnerUid === user.uid) { statusText = 'ìŠ¹ë¦¬!'; statusColor = 'text-green-400'; }
        else { statusText = 'íŒ¨ë°°...'; statusColor = 'text-red-400'; }
      } else if (phase === 'finished') {
        const ms = myGame?.score || 0, os = oppGame?.score || 0;
        if (ms > os) { statusText = 'ìµœì¢… ìŠ¹ë¦¬!'; statusColor = 'text-yellow-400'; }
        else if (ms < os) { statusText = 'ìµœì¢… íŒ¨ë°°...'; statusColor = 'text-red-400'; }
        else { statusText = 'ë¬´ìŠ¹ë¶€!'; statusColor = 'text-yellow-400'; }
      }

      const displayMyCard = phase === 'result' || phase === 'finished' ? (last?.[user.uid]?.effective ?? myGame?.effectiveCard ?? myGame?.selectedCard) : (myGame?.effectiveCard ?? myGame?.selectedCard);
      const displayOppCard = phase === 'skill' || phase === 'result' || phase === 'finished' ? (phase === 'result' || phase === 'finished' ? last?.[oppUid]?.effective : oppGame?.effectiveCard) ?? oppGame?.selectedCard : null;

      return (
        <div className="min-h-screen flex flex-col lg:flex-row p-2 gap-2 animate-fade-in">
          {/* ë©”ì¸ ê²Œì„ */}
          <div className="flex-1 flex flex-col">
            <div className="glass rounded-2xl p-4 flex-1 flex flex-col relative">
              {/* ì´í™íŠ¸ */}
              {effects.map(e => <div key={e.id} className="effect-text text-yellow-400" style={{ left: '50%', top: '40%', transform: 'translateX(-50%)' }}>{e.type}</div>)}

              {/* ìƒë‹¨ ì •ë³´ */}
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 rounded-full bg-red-900/50 border-2 border-red-600 flex items-center justify-center font-bold text-red-300">{oppInfo?.name?.[0] ?? '?'}</div>
                  <div><p className="font-bold text-red-300 text-sm">{oppInfo?.name ?? 'ìƒëŒ€'}</p><p className="text-xs text-red-300/60">ì ìˆ˜: {oppGame?.score ?? 0}</p></div>
                </div>
                <div className="text-center bg-black/30 px-4 py-2 rounded-lg">
                  <p className="text-xs text-slate-400">R{game.currentRound}/{game.maxRounds}</p>
                  <p className="text-lg font-bold text-white">T{game.currentTurn}/11</p>
                </div>
                <div className="flex items-center gap-2">
                  <div className="text-right"><p className="font-bold text-blue-300 text-sm">{myInfo?.name}</p><p className="text-xs text-blue-300/60">ì ìˆ˜: {myGame?.score ?? 0}</p></div>
                  <div className="w-10 h-10 rounded-full bg-blue-900/50 border-2 border-blue-600 flex items-center justify-center font-bold text-blue-300">{myInfo?.name?.[0]}</div>
                </div>
              </div>

              {/* íƒ€ì´ë¨¸ */}
              {phase === 'skill' && <div className="w-full bg-black/30 rounded-full h-1 mb-4 overflow-hidden"><div className="timer-bar h-full" style={{ width: `${(timer/10)*100}%` }}></div></div>}

              {/* ìƒíƒœ */}
              <div className="text-center py-2"><p className={`text-xl font-bold ${statusColor}`}>{statusText}</p></div>

              {/* ì¹´ë“œ ì˜ì—­ */}
              <div className="flex-1 flex items-center justify-center gap-8 py-4">
                <div className="text-center">
                  <p className="text-xs text-red-300/60 mb-2">ìƒëŒ€</p>
                  <div className={`w-16 h-24 rounded-lg border-2 flex items-center justify-center text-3xl font-bold transition-all ${displayOppCard !== null ? 'bg-white text-slate-900 border-red-400' : 'bg-red-900/50 border-red-700 text-red-700'}`}>{displayOppCard !== null ? displayOppCard : '?'}</div>
                </div>
                <div className="text-3xl font-black text-slate-700">VS</div>
                <div className="text-center">
                  <p className="text-xs text-blue-300/60 mb-2">ë‚˜</p>
                  <div className={`w-16 h-24 rounded-lg border-2 flex items-center justify-center text-3xl font-bold transition-all ${displayMyCard !== null ? 'bg-white text-slate-900 border-blue-400' : 'bg-blue-900/50 border-blue-700 text-blue-700'}`}>{displayMyCard !== null ? displayMyCard : '-'}</div>
                </div>
              </div>

              {/* ìŠ¤í‚¬ */}
              <div className="mb-4">
                <p className="text-xs text-slate-400 mb-2">ìŠ¤í‚¬ ({(myGame?.skills || []).length})</p>
                <div className="flex flex-wrap gap-2">
                  {(myGame?.skills || []).length === 0 ? <span className="text-slate-500 text-sm">ì—†ìŒ</span> : (myGame?.skills || []).map((sid, idx) => {
                    const def = SKILL_DEFS[sid];
                    return <button key={idx} disabled={phase !== 'skill' || timer <= 0} onClick={() => useSkill(sid, idx)} className={`px-3 py-1 rounded-lg text-sm font-bold text-white transition-all active:scale-95 ${def?.color || 'bg-gray-600'} disabled:opacity-40 disabled:cursor-not-allowed hover:brightness-110`} title={def?.desc}>{def?.name}</button>;
                  })}
                </div>
              </div>

              {/* ì†íŒ¨ */}
              <div>
                <p className="text-xs text-slate-400 mb-2">ì†íŒ¨ ({(myGame?.hand || []).length})</p>
                <div className="flex flex-wrap gap-1 justify-center">
                  {(myGame?.hand || []).map(c => (
                    <button key={c} disabled={phase !== 'select'} onClick={() => selectCard(c)} className={`w-11 h-16 rounded-lg border-2 flex items-center justify-center text-lg font-bold transition-all active:scale-95 ${myGame?.selectedCard === c ? 'bg-yellow-400 text-black border-yellow-500 -translate-y-1 shadow-lg' : 'bg-white text-slate-900 border-slate-300'} ${phase !== 'select' ? 'opacity-50 cursor-not-allowed' : 'hover:-translate-y-1 hover:shadow-md'}`}>{c}</button>
                  ))}
                </div>
              </div>

              {/* í•˜ë‹¨ ë²„íŠ¼ */}
              <div className="flex justify-between items-center mt-4 pt-4 border-t border-slate-700">
                <button onClick={handleExitGame} className="text-sm text-slate-500 hover:text-white">ë‚˜ê°€ê¸°</button>
                {phase === 'skill' && isHost && <button onClick={resolveRound} className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-white active:scale-95">ê²°ê³¼ í™•ì •</button>}
                {phase === 'result' && <button onClick={setReady} disabled={myGame?.ready} className={`px-4 py-2 rounded-lg font-bold text-white active:scale-95 ${myGame?.ready ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-500'}`}>{myGame?.ready ? 'âœ“ ëŒ€ê¸°ì¤‘' : 'ë‹¤ìŒ í„´'}</button>}
                {phase === 'finished' && <button onClick={handleExitGame} className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-white active:scale-95">ë¡œë¹„ë¡œ</button>}
              </div>
            </div>
          </div>

          {/* ìŠ¤í‚¬ ë¡œê·¸ */}
          <div className="w-full lg:w-72">
            <div className="glass rounded-2xl p-4 h-full flex flex-col">
              <h3 className="text-white font-bold mb-3 text-center">ğŸ“œ ìŠ¤í‚¬ ë¡œê·¸</h3>
              <div className="flex-1 overflow-y-auto space-y-2 max-h-64 lg:max-h-[calc(100vh-150px)]">
                {(game.skillLog || []).length === 0 ? <p className="text-slate-500 text-sm text-center">ì•„ì§ ì—†ìŒ</p> : (game.skillLog || []).slice().reverse().map((log, idx) => {
                  const def = SKILL_DEFS[log.skillId];
                  return (
                    <div key={idx} className={`p-2 rounded-lg text-xs animate-fade-in ${log.nullified ? 'bg-black/30 opacity-50 line-through' : 'bg-black/20'}`}>
                      {log.desc ? <p className="text-slate-300">{log.desc}</p> : <>
                        <p className="text-slate-300"><span className={log.byUid === user.uid ? 'text-blue-400' : 'text-red-400'}>{log.byName}</span> â†’ {def?.name}</p>
                        {log.beforeVal !== undefined && <p className="text-slate-400 mt-1">{log.beforeVal} â†’ <span className="text-yellow-400 font-bold">{log.afterVal}</span>{log.nullified && <span className="text-red-400 ml-1">(ë¬´ë ¥í™”)</span>}</p>}
                      </>}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* ë¬´ë ¥í™” ëª¨ë‹¬ */}
          {nullifyMode && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 animate-fade-in p-4">
              <div className="glass rounded-2xl p-6 max-w-md w-full">
                <h3 className="text-xl font-bold text-white mb-4 text-center">ë¬´ë ¥í™”í•  ìŠ¤í‚¬ ì„ íƒ</h3>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {nullifyMode.oppLogs.map((log, idx) => (
                    <button key={idx} onClick={() => executeNullify(log)} className="w-full p-3 bg-slate-700 hover:bg-red-900/50 rounded-lg text-left transition-colors active:scale-95">
                      <p className="text-white font-bold">{SKILL_DEFS[log.skillId]?.name}</p>
                      <p className="text-xs text-slate-400">{log.beforeVal} â†’ {log.afterVal}</p>
                    </button>
                  ))}
                </div>
                <button onClick={() => setNullifyMode(null)} className="w-full mt-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white active:scale-95">ì·¨ì†Œ</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>